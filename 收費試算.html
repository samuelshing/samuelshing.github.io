<!DOCTYPE html>
<html lang="zh-Hant">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>活動費用計算器</title>
    <!-- Bootstrap 4 -->
    <link href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet" />
    <!-- Vue 2 -->
    <script src="https://cdn.jsdelivr.net/npm/vue@2.6.14/dist/vue.js"></script>
</head>

<body>
    <div id="app" class="container my-5">
        <h1 class="text-center mb-4">活動費用計算器</h1>

        <form id="costForm">
            <div class="form-row">
                <div class="form-group col-md-4">
                    <label>活動人數(位)：</label>
                    <input type="number" class="form-control" v-model.number="participants" min="0" required>
                    <small class="form-text text-muted">所需組長人數：{{ leaderCount }}</small>
                </div>

                <div class="form-group col-md-4">
                    <label>額外人員(位)：</label>
                    <input type="number" class="form-control" v-model.number="extraStaff" min="0" required>
                </div>

                <div class="form-group col-md-4">
                    <label>活動時長(小時)：</label>
                    <input type="number" class="form-control" v-model.number="duration" min="0" step="0.5" required>
                </div>
            </div>

            <div class="form-row">
                <div class="form-group col-md-4">
                    <label>來回里程(公里)：</label>
                    <select class="form-control" v-model.number="distance" required>
                        <option disabled value="">請選擇</option>
                        <option value="50">基隆(50公里)</option>
                        <option value="40">新北(40公里)</option>
                        <option value="100">桃園(100公里)</option>
                        <option value="160">新竹(160公里)</option>
                        <option value="240">苗栗(240公里)</option>
                        <option value="300">台中(300公里)</option>
                        <option value="360">彰化(360公里)</option>
                        <option value="400">南投(400公里)</option>
                        <option value="440">雲林(440公里)</option>
                        <option value="520">嘉義(520公里)</option>
                        <option value="600">台南(600公里)</option>
                        <option value="700">高雄(700公里)</option>
                        <option value="760">屏東(760公里)</option>
                        <option value="120">宜蘭(120公里)</option>
                        <option value="360">花蓮(360公里)</option>
                        <option value="660">台東(660公里)</option>
                    </select>
                    <small class="form-text text-muted">推估車輛數量：{{ vehicleCount }}</small>
                </div>

                <div class="form-group col-md-4">
                    <label>額外費用(元)：</label>
                    <input type="number" class="form-control" v-model.number="extraCost" min="0" required>
                </div>

                <div class="form-group col-md-4">
                    <label>折扣(%)：</label>
                    <input type="number" class="form-control" v-model.number="discount" min="0" max="100" required>
                </div>
            </div>
        </form>

        <!-- 進階設定（折疊） -->
        <div class="card mt-3">
            <div class="card-header d-flex justify-content-between align-items-center">
                <span class="font-weight-bold">進階設定</span>
                <button class="btn btn-sm btn-outline-secondary" type="button" data-toggle="collapse"
                    data-target="#advancedSettings" aria-expanded="false" aria-controls="advancedSettings">
                    展開 / 收合
                </button>
            </div>
            <div id="advancedSettings" class="collapse">
                <div class="card-body">
                    <div class="form-row">
                        <div class="form-group col-md-2">
                            <label>每小時費用 (元/人)</label>
                            <input type="number" class="form-control" v-model.number="C_L" min="0" step="1">
                            <small class="text-muted">預設 200</small>
                        </div>
                        <div class="form-group col-md-3">
                            <label>組長組員配比（每幾位配置1組長）</label>
                            <input type="number" class="form-control" v-model.number="leaderRatio" min="1" step="1">
                            <small class="text-muted">預設 8 → 每 8 人 1 組長</small>
                        </div>
                        <div class="form-group col-md-3">
                            <label>每輛車乘坐人數上限</label>
                            <input type="number" class="form-control" v-model.number="carCapacity" min="1" step="1">
                            <small class="text-muted">預設 4（僅載組長＋額外人員）</small>
                        </div>
                        <div class="form-group col-md-2">
                            <label>油價 (元/公升)</label>
                            <input type="number" class="form-control" v-model.number="C_F" min="0" step="0.1">
                            <small class="text-muted">預設 30</small>
                        </div>
                        <div class="form-group col-md-2">
                            <label>油耗 (km/L)</label>
                            <input type="number" class="form-control" v-model.number="E" min="0.1" step="0.1">
                            <small class="text-muted">預設 10</small>
                        </div>
                        <div class="form-group col-md-2">
                            <label>平均時速 (km/h)</label>
                            <input type="number" class="form-control" v-model.number="V_speed" min="1" step="1">
                            <small class="text-muted">預設 80</small>
                        </div>
                    </div>
                    <button class="btn btn-sm btn-outline-primary" @click="resetAdvanced">重設為預設值</button>
                </div>
            </div>
        </div>

        <h2 class="mt-3">總費用：<span class="text-primary">{{ formatCurrency(roundedTotalCost) }}</span></h2>

        <!-- 明細表格 -->
        <div class="card mt-4">
            <div class="card-header font-weight-bold">費用明細</div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table mb-0">
                        <thead class="thead-light">
                            <tr>
                                <th>項目</th>
                                <th>計算說明</th>
                                <th class="text-right">金額(元)</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>人員費用</td>
                                <td>
                                    人員數 {{ staffCount }} 人（組長 {{ leaderCount }} + 額外人員 {{ extraStaff }}） × (活動 {{ duration }} 小時 + 車程 {{ travelHours.toFixed(2) }} 小時) × 每小時 {{ C_L }} 元
                                    <br>
                                    <small class="text-muted">
                                        車程小時＝里程 {{ distance || 0 }} ÷ 平均時速 {{ V_speed }} km/h
                                    </small>
                                </td>
                                <td class="text-right">{{ formatCurrency(costStaff) }}</td>
                            </tr>
                            <tr>
                                <td>交通油費</td>
                                <td>
                                    里程 {{ distance || 0 }} 公里 ÷ 油耗 {{ E }} km/公升 × 油價 {{ C_F }} 元/公升 × 車輛 {{
                                    vehicleCount }} 輛
                                    <br>
                                    <small class="text-muted">
                                        車輛數（僅載組長＋額外人員）：(組長 {{ leaderCount }} + 額外人員 {{ extraStaff }}) ÷ 車輛上限 {{ carCapacity }} → 向上進位
                                    </small>
                                </td>
                                <td class="text-right">{{ formatCurrency(costFuel) }}</td>
                            </tr>
                            <tr>
                                <td>額外費用</td>
                                <td>其他雜支 / 場地費 / 設備等</td>
                                <td class="text-right">{{ formatCurrency(extraCost) }}</td>
                            </tr>
                            <tr>
                                <td>折扣</td>
                                <td>小計 × 折扣 {{ discount }}%</td>
                                <td class="text-right text-success">-{{ formatCurrency(discountAmount) }}</td>
                            </tr>
                            <tr class="font-weight-bold">
                                <td>合計(四捨五入到百元)</td>
                                <td>四捨五入前：{{ formatCurrency(totalCost) }}</td>
                                <td class="text-right">{{ formatCurrency(roundedTotalCost) }}</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- 收費依據 -->
        <div class="mt-4">
            <h5>收費依據說明</h5>
            <ul class="mb-2">
                <li>人員計費：<strong>每 {{ leaderRatio }} 位參加者配置 1 名組長</strong>（向上進位）。人員＝組長 + 額外人員；每位<strong>每小時 {{ C_L }} 元</strong>計算，時數含活動時數與往返車程時間。</li>
                <li>交通費用：<strong>車輛僅載工作人員（組長＋額外人員）</strong>，以<strong>每輛車最多 {{ carCapacity }} 人</strong>估算車數。</li>
                <li>油資假設：<strong>平均油耗 {{ E }} km/公升</strong>、<strong>油價 {{ C_F }} 元/公升</strong>，<strong>平均時速 {{ V_speed }} km/h</strong>（用於估算車程時間）。</li>
                <li>折扣：對「人員費用 + 交通油費 + 額外費用」的小計套用折扣百分比。</li>
                <li>報價：為便於對帳，合計以<strong>四捨五入至百元</strong>呈現。</li>
            </ul>
        </div>
    </div>

    <!-- Bootstrap JS & jQuery -->
    <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.9.2/dist/umd/popper.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>

    <script>
        new Vue({
            el: '#app',
            data: {
                // 使用者輸入
                participants: 0,
                extraStaff: 0,
                duration: 0,
                distance: "",  // 使用 disabled 的「請選擇」
                extraCost: 0,
                discount: 0,

                // 收費參數（可調整）
                C_L: 200,      // 每小時費用 (TWD/人)
                leaderRatio: 8,
                carCapacity: 4,
                C_F: 30,       // 油價 (TWD/L)
                E: 10,         // 油耗 (km/L)
                V_speed: 80    // 平均時速 (km/h)
            },
            computed: {
                leaderCount() {
                    const ratio = Math.max(1, Math.floor(this.leaderRatio || 1));
                    return Math.ceil((this.participants || 0) / ratio);
                },
                staffCount() {
                    return (this.leaderCount || 0) + (this.extraStaff || 0);
                },
                vehicleCount() {
                    // 僅載工作人員（組長 + 額外人員）
                    const cap = Math.max(1, Math.floor(this.carCapacity || 1));
                    return Math.max(0, Math.ceil(this.staffCount / cap));
                },
                travelHours() {
                    const dist = Number(this.distance) || 0;
                    const speed = Math.max(1, Number(this.V_speed) || 1);
                    return dist > 0 ? (dist / speed) : 0;
                },
                costStaff() {
                    const hours = (Number(this.duration) || 0) + this.travelHours;
                    return Math.max(0, this.staffCount * hours * (Number(this.C_L) || 0));
                },
                costFuel() {
                    const dist = Number(this.distance) || 0;
                    if (dist <= 0) return 0;
                    const e = Math.max(0.1, Number(this.E) || 0.1);
                    const price = Math.max(0, Number(this.C_F) || 0);
                    const litersPerCar = dist / e;
                    return Math.max(0, litersPerCar * price * this.vehicleCount);
                },
                subtotal() {
                    return this.costStaff + this.costFuel + (Number(this.extraCost) || 0);
                },
                discountAmount() {
                    const d = Math.min(Math.max(Number(this.discount) || 0, 0), 100);
                    return this.subtotal * (d / 100);
                },
                totalCost() {
                    return Math.max(0, this.subtotal - this.discountAmount);
                },
                roundedTotalCost() {
                    return Math.round(this.totalCost / 100) * 100;
                }
            },
            methods: {
                formatCurrency(n) {
                    return Math.round(n).toLocaleString('zh-Hant-TW');
                },
                resetAdvanced() {
                    this.C_L = 200;
                    this.leaderRatio = 8;
                    this.carCapacity = 4;
                    this.C_F = 30;
                    this.E = 10;
                    this.V_speed = 80;
                }
            }
        });
    </script>
</body>

</html>