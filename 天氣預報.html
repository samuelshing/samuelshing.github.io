<!DOCTYPE html>
<html lang="zh-Hant">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ–°åŒ—å¸‚å¤©æ°£é å ±èˆ‡å³æ™‚é›¨é‡</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">

    <!-- å¼•å…¥ Tone.js ç”¨æ–¼æ’­æ”¾éŸ³æ•ˆ -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.7.77/Tone.js"></script>

    <style>
        body {
            background-color: #f8f9fa;
        }

        #app {
            max-width: 1200px;
            margin: auto;
            padding: 1rem;
        }

        .location-section {
            background-color: white;
            padding: 2rem;
            border-radius: 0.5rem;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        }

        .chart-container,
        .rain-chart-container {
            position: relative;
            height: 40vh;
            min-height: 300px;
        }

        /* å¡ç‰‡æ¨£å¼ */
        .realtime-rain-card,
        .radar-card {
            background-color: #ffffff;
            border: 1px solid #dee2e6;
            border-radius: 0.375rem;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            transition: all 0.3s ease;
        }

        .radar-card.alert-active {
            border-color: #dc3545;
            background-color: #fff5f5;
        }

        /* ç„¦é»å¼•å°æ¨£å¼ */
        .tour-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background-color: rgba(0, 0, 0, 0.4);
            backdrop-filter: grayscale(80%) blur(2px);
            z-index: 9998;
        }

        .tour-highlight-focus {
            position: relative;
            z-index: 9999;
            box-shadow: 0 0 0 10px rgba(255, 255, 255, 0.7);
            border-radius: 5px;
            animation: pulse 1.5s infinite;
        }

        .tour-tooltip {
            position: absolute;
            background-color: white;
            padding: 1rem;
            border-radius: 5px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            z-index: 10000;
            max-width: 300px;
        }

        @keyframes pulse {
            0% {
                box-shadow: 0 0 0 0px rgba(255, 255, 255, 0.7);
            }

            70% {
                box-shadow: 0 0 0 15px rgba(255, 255, 255, 0);
            }

            100% {
                box-shadow: 0 0 0 0px rgba(255, 255, 255, 0);
            }
        }
    </style>
</head>

<body>
    <!-- <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container">
            <a class="navbar-brand" href="./index.html">
                <i class="bi bi-code-slash"></i>
                åŠŸèƒ½å…¥å£
            </a>
        </div>
    </nav> -->

    <div id="app">
        <!-- ç„¦é»å¼•å°é®ç½© -->
        <div v-if="showOnboarding" class="tour-overlay" @click="closeTour"></div>

        <!-- ç„¦é»å¼•å°æç¤ºæ¡† -->
        <div v-if="showOnboarding" class="tour-tooltip" :style="tooltipStyle">
            <strong>å•Ÿç”¨è²éŸ³è­¦ç¤º</strong>
            <p class="mb-0 small text-muted mt-2">
                è«‹é»æ“Šæ­¤æŒ‰éˆ•ï¼Œä»¥å…è¨±ç€è¦½å™¨æ’­æ”¾å³æ™‚è­¦ç¤ºéŸ³æ•ˆèˆ‡èªéŸ³ã€‚
            </p>
            <small class="text-muted d-block mt-2">(é»æ“Šä»»æ„ç°è‰²å€åŸŸå¯é—œé–‰æç¤º)</small>
        </div>

        <div class="app-content">
            <header class="text-center my-4">
                <h1 class="display-5 fw-bold">ğŸ™ï¸ æ–°åŒ—å¸‚å¤©æ°£ç›£æ§ç³»çµ±</h1>
                <p class="text-muted">ï¼ˆé›·é”å³æ™‚å›æ³¢æƒæï½œé å ±è¶¨å‹¢ï½œå³æ™‚é›¨é‡è§€æ¸¬ï¼‰</p>
                <!-- å•Ÿç”¨éŸ³è¨ŠæŒ‰éˆ• -->
                <button v-if="!isAudioEnabled" ref="enableAudioButtonRef" class="btn btn-info btn-sm"
                    :class="{ 'tour-highlight-focus': showOnboarding }" @click="enableAudio">
                    <i class="bi bi-bell-fill"></i> å•Ÿç”¨è²éŸ³è­¦ç¤º
                </button>
                <span v-if="isAudioEnabled" class="text-success small"><i class="bi bi-check-circle-fill"></i>
                    è²éŸ³å·²å•Ÿç”¨</span>
                <!-- è²éŸ³èªªæ˜ -->
                <small v-if="!isAudioEnabled && !showOnboarding" class="text-center text-muted d-block mt-2">* è«‹é»æ“Šã€Œå•Ÿç”¨è²éŸ³è­¦ç¤ºã€ä»¥å…è¨±ç€è¦½å™¨æ’­æ”¾å³æ™‚è­¦ç¤ºéŸ³æ•ˆèˆ‡èªéŸ³ã€‚</small>

                <!-- å€’æ•¸è¨ˆæ™‚å™¨ -->
                <p class="text-center text-success fw-bold" v-if="!isLoading && !error">
                    <i class="bi bi-arrow-clockwise"></i>
                    APIè³‡æ–™æ¯5åˆ†é˜æ›´æ–°ï¼Œå°‡æ–¼ {{ countdownMinutes }} åˆ† {{ countdownSeconds }} ç§’å¾Œè‡ªå‹•æ›´æ–°...
                </p>
                <!-- æ›´æ–°æ™‚é–“è¨­å®š -->
                <div class="d-flex justify-content-center align-items-center mt-2 gap-2">
                    æ¯
                    <input type="number" class="form-control" v-model.number="newCountdownValue" min="1" placeholder="ç§’æ•¸" style="width: 100px;">
                    ç§’æ›´æ–°è³‡è¨Š
                    <button class="btn btn-secondary btn-sm" @click="applyNewCountdown">è¨­å®š</button>
                </div>
            </header>

            <!-- è¼‰å…¥ä¸­ç‹€æ…‹ -->
            <div v-if="isLoading" class="text-center my-5">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <p class="mt-2">æ­£åœ¨è¼‰å…¥å¤©æ°£è³‡æ–™...</p>
            </div>

            <!-- éŒ¯èª¤è¨Šæ¯ -->
            <div v-if="error" class="alert alert-danger" role="alert">
                <i class="bi bi-exclamation-triangle-fill"></i>
                <strong>è³‡æ–™è¼‰å…¥å¤±æ•—ï¼š</strong> {{ error }}
            </div>

            <main v-if="!isLoading && !error" class="d-flex flex-column gap-4">
                <!-- é›·é”æƒæå€å¡Š -->
                <section>
                    <h2 class="text-center mb-3">ğŸ“¡ é›·é”å›æ³¢åµæ¸¬ (å³æ™‚é™é›¨åˆ¤æ–·)</h2>
                    <p class="text-center text-secondary small mb-3">
                        <i class="bi bi-info-circle"></i> dBZ å›æ³¢å€¼è¶Šé«˜ä»£è¡¨é™é›¨è¶ŠåŠ‡çƒˆã€‚>15 dBZ åˆ¤å®šç‚ºæœ‰é›¨ã€‚
                    </p>

                    <div v-if="radarObservation.length > 0" class="row g-4">
                        <div v-for="loc in radarObservation" :key="loc.name" class="col-md-4">
                            <div class="p-3 radar-card h-100 d-flex flex-column"
                                :class="{'alert-active': loc.dbz >= 15}">
                                <div class="d-flex justify-content-between">
                                    <h5 class="mb-3">{{ loc.name }}</h5>
                                    <span :class="loc.dbz >= 15 ? 'text-danger fw-bold' : 'text-success'">
                                        {{ loc.status }}
                                    </span>
                                </div>
                                <div class="display-6 text-center my-2">
                                    {{ loc.dbz }} <span class="h6">dBZ</span>
                                </div>
                                <div class="progress" style="height: 10px;">
                                    <div class="progress-bar" role="progressbar"
                                        :style="{width: (Math.min(loc.dbz, 60) / 60 * 100) + '%', backgroundColor: getRadarColor(loc.dbz)}">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- å³æ™‚é›¨é‡è§€æ¸¬å€å¡Š -->
                <section>
                    <h2 class="text-center mb-3">ğŸ’§ å³æ™‚é›¨é‡è§€æ¸¬</h2>

                    <!-- å³æ™‚é™é›¨è­¦ç¤º (ç•¶é›¨é‡ç«™æ•¸æ“šé”æ¨™æ™‚é¡¯ç¤º) -->
                    <div v-if="immediateAlertMessage" class="alert alert-danger alert-dismissible fade show mt-3 shadow-sm"
                        role="alert" style="max-width: 800px; margin-left: auto; margin-right: auto;">
                        <i class="bi bi-exclamation-triangle-fill me-2"></i>
                        <strong>å³æ™‚é™é›¨è­¦ç¤ºï¼š</strong> {{ immediateAlertMessage }}
                        <button type="button" class="btn-close" @click="clearImmediateAlert"></button>
                    </div>
                    <div v-if="rainObservation.length > 0" class="row g-4">
                        <div v-for="station in rainObservation" :key="station.StationId" class="col-md-4">
                            <div class="p-3 realtime-rain-card h-100 d-flex flex-column">
                                <h5 class="mb-3">{{ station.TownName }} ({{ station.StationName }})</h5>
                                <ul class="list-group list-group-flush flex-grow-1">
                                    <li class="list-group-item d-flex justify-content-between align-items-center">
                                        10åˆ†é˜é›¨é‡
                                        <span class="badge bg-primary rounded-pill fs-6">{{ station.Past10Min }}
                                            mm</span>
                                    </li>
                                    <li class="list-group-item d-flex justify-content-between align-items-center">
                                        1å°æ™‚é›¨é‡
                                        <span class="badge bg-secondary rounded-pill fs-6">{{ station.Past1hr }}
                                            mm</span>
                                    </li>
                                    <li class="list-group-item d-flex justify-content-between align-items-center">
                                        24å°æ™‚é›¨é‡
                                        <span class="badge bg-secondary rounded-pill fs-6">{{ station.Past24hr }}
                                            mm</span>
                                    </li>
                                </ul>
                                <small class="text-muted mt-3 d-block text-center">
                                    è§€æ¸¬æ™‚é–“: {{ formatFullDateTime(station.ObsTime) }}
                                </small>
                            </div>
                        </div>
                    </div>
                    <div v-else class="text-center text-muted">
                        <div class="spinner-border spinner-border-sm text-primary" role="status"></div>
                        æ­£åœ¨è¼‰å…¥å³æ™‚é›¨é‡è³‡æ–™...
                    </div>
                </section>

                <!-- å¤©æ°£é å ±å€å¡Š -->
                <section class="location-section">
                    <h2 class="text-center mb-3">ğŸŒ¦ï¸ æœªä¾†24å°æ™‚å¤©æ°£é å ±</h2>

                    <!-- é™é›¨é å ±è­¦ç¤º (ç•¶æœªä¾†ä¸‰å°æ™‚é å ±è½‰é›¨æ™‚é¡¯ç¤º) -->
                    <div v-if="forecastAlertMessage" class="alert alert-warning alert-dismissible fade show mt-3 shadow-sm"
                        role="alert" style="max-width: 800px; margin-left: auto; margin-right: auto;">
                        <i class="bi bi-clock-fill me-2"></i>
                        <strong>é å ±è­¦å ±ï¼š</strong> {{ forecastAlertMessage }}
                        <button type="button" class="btn-close" @click="clearForecastAlert"></button>
                    </div>
                    <!-- é å ±åœ–è¡¨ (v-for) -->
                    <div v-for="location in locations" :key="location.name" class="mt-5">
                        <h3 class="mb-4 border-bottom pb-2">{{ location.name }}</h3>
                        <div class="row">
                            <div class="col-lg-4">
                                <h4 class="h5 text-muted">é™é›¨åˆ†ä½ˆåœ–</h4>
                                <div class="rain-chart-container mb-5">
                                    <canvas :id="'rain-chart-' + location.name"></canvas>
                                </div>
                            </div>
                            <div class="col-lg-8">
                                <h4 class="h5 text-muted">æº«åº¦èˆ‡é™é›¨æ©Ÿç‡</h4>
                                <div class="chart-container mb-5">
                                    <canvas :id="'chart-' + location.name"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                </section>
            </main>
            <footer class="text-center text-muted mt-5">
                <p>è³‡æ–™ä¾†æºï¼š<a href="https://opendata.cwa.gov.tw/" target="_blank">äº¤é€šéƒ¨ä¸­å¤®æ°£è±¡ç½²</a></p>
                <p>è³‡æ–™APIï¼š
                    <a href="https://opendata.cwa.gov.tw/dist/opendata-swagger.html#/%E9%A0%90%E5%A0%B1/get_v1_rest_datastore_F_D0047_069"
                        target="_blank">å¤©æ°£é å ±</a> |
                    <a href="https://opendata.cwa.gov.tw/dist/opendata-swagger.html#/%E8%A7%80%E6%B8%AC/get_v1_rest_datastore_O_A0002_001"
                        target="_blank">é›¨é‡è§€æ¸¬</a>
                </p>
            </footer>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/vue@3/dist/vue.global.prod.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <script>
        const { createApp } = Vue;

        window.app = createApp({
            data() {
                return {
                    // CWA æ°£è±¡ç½² API
                    forecastApiUrl: 'https://opendata.cwa.gov.tw/api/v1/rest/datastore/F-D0047-069?Authorization=CWA-F36D4CE9-10F1-43BA-82E6-8E7DA63697F7&format=JSON&LocationName=æ–°åº—å€,ä¸­å’Œå€,æ¿æ©‹å€&ElementName=3å°æ™‚é™é›¨æ©Ÿç‡,æº«åº¦,å¤©æ°£ç¾è±¡,é«”æ„Ÿæº«åº¦',
                    rainApiUrl: 'https://opendata.cwa.gov.tw/api/v1/rest/datastore/O-A0002-001?Authorization=CWA-F36D4CE9-10F1-43BA-82E6-8E7DA63697F7&format=JSON&StationId=466881,C0AG80,C0AJ80',
                    radarApiUrl: 'https://opendata.cwa.gov.tw/fileapi/v1/opendataapi/O-A0059-001?Authorization=CWA-F36D4CE9-10F1-43BA-82E6-8E7DA63697F7&format=JSON',
                    // radarApiUrl: './get_radar.php',

                    // è³‡æ–™å­˜å„²
                    radarObservation: [],
                    previousRadarDBZ: {},
                    rainObservation: [],
                    locations: [],

                    // UI ç‹€æ…‹
                    isLoading: true,
                    error: null,
                    showOnboarding: true,
                    isAudioEnabled: false,
                    tooltipStyle: { top: '0px', left: '0px' },

                    // è¨ˆæ™‚å™¨
                    rainCountdown: 300,        // åŸç‚º 600 -> æ”¹ç‚º 300
                    countdown: 300,            // åŸç‚º 3600 -> æ”¹ç‚º 300
                    dataInterval: null,
                    rainInterval: null,
                    radarInterval: null,
                    activeCountdownSetting: 300, // åŸç‚º 3600 -> æ”¹ç‚º 300
                    newCountdownValue: 300,      // åŸç‚º 3600 -> æ”¹ç‚º 300 (è¼¸å…¥æ¡†é è¨­å€¼)

                    // æŒ‡å®šæƒæåº§æ¨™
                    targetPoints: [
                        { name: "æ–°åº—", lat: 24.9828108, lng: 121.541716 },
                        { name: "ä¸­å’Œ", lat: 25.002385, lng: 121.496251 },
                        { name: "æ¿æ©‹", lat: 25.0153035, lng: 121.464625 }
                    ],

                    chartInstances: {},
                    rainChartInstances: {},
                    selectedVoice: null,
                    rainLevelsText: ['ç„¡é›¨', 'å°é›¨', 'ä¸­é›¨', 'å¤§é›¨', 'æš´é›¨'],
                    immediateAlertMessage: null,
                    forecastAlertMessage: null,
                };
            },
            computed: {
                countdownMinutes() {
                    return Math.floor(this.countdown / 60);
                },
                countdownSeconds() {
                    return (this.countdown % 60).toString().padStart(2, '0');
                },
                rainCountdownMinutes() {
                    return Math.floor(this.rainCountdown / 60);
                },
                rainCountdownSeconds() {
                    return (this.rainCountdown % 60).toString().padStart(2, '0');
                }
            },
            methods: {
                // --- é›·é”å›æ³¢è™•ç† ---
                async fetchRadarData() {
                    try {
                        const response = await axios.get(this.radarApiUrl);
                        const dataset = response.data.cwaopendata.dataset;
                        const info = dataset.datasetInfo.parameterSet;
                        const content = dataset.contents.content;

                        const startLng = parseFloat(info.StartPointLongitude);
                        const startLat = parseFloat(info.StartPointLatitude);
                        const res = parseFloat(info.GridResolution);
                        const dimX = parseInt(info.GridDimensionX);

                        const dbzValues = content.split(',').map(v => parseFloat(v));
                        const results = [];
                        let alertTriggered = false;
                        let alertText = "";

                        this.targetPoints.forEach(point => {
                            const x_idx = Math.round((point.lng - startLng) / res);
                            const y_idx = Math.round((point.lat - startLat) / res);
                            const index = y_idx * dimX + x_idx;

                            let val = dbzValues[index] || 0;
                            if (val < 0) val = 0;

                            const prevVal = this.previousRadarDBZ[point.name] || 0;

                            let status = "ç„¡é™é›¨å›æ³¢";
                            if (val >= 45) status = "åŠ‡çƒˆé›·é›¨";
                            else if (val >= 30) status = "æŒçºŒé™é›¨";
                            else if (val >= 15) status = "å¾®é›¨åµæ¸¬";

                            // åˆ¤æ–·æ˜¯å¦ã€Œå‰›å‰›é–‹å§‹ã€åµæ¸¬åˆ°é™é›¨å›æ³¢
                            if (val >= 15 && prevVal < 15) {
                                alertTriggered = true;
                                alertText += `${point.name}åœ°å€é›·é”å›æ³¢å¢å¼·è‡³ ${val} dBZï¼Œ`;
                            }

                            results.push({ name: point.name, dbz: val, status: status });
                            this.previousRadarDBZ[point.name] = val;
                        });

                        this.radarObservation = results;

                        if (alertTriggered && this.isAudioEnabled) {
                            this.playAlertSound();
                            setTimeout(() => this.speakAlert("é›·é”æƒæé€šçŸ¥ï¼š" + alertText + "è«‹æ³¨æ„é™é›¨è¶¨å‹¢ã€‚"), 1500);
                        }
                    } catch (err) {
                        console.error("é›·é”æ•¸æ“šç²å–å¤±æ•—:", err);
                    }
                },
                getRadarColor(dbz) {
                    if (dbz >= 45) return '#ff0000';
                    if (dbz >= 30) return '#ffa500';
                    if (dbz >= 15) return '#00ff00';
                    return '#dee2e6';
                },
                // --- ä¸»è¦è³‡æ–™ç²å– ---
                async fetchWeatherData() {
                    // é å ±å€’æ•¸é‡è¨­
                    this.countdown = this.activeCountdownSetting;
                    try {
                        const response = await axios.get(this.forecastApiUrl);
                        if (response.data.success !== "true") throw new Error('API å›æ‡‰éŒ¯èª¤');
                        this.processForecastData(response.data);
                        this.checkForecastAlert(this.locations);

                        // ç¢ºä¿ DOM æ¸²æŸ“å®Œç•¢
                        this.$nextTick(() => {
                            this.$nextTick(() => {
                                this.renderAllCharts();
                            });
                        });
                    } catch (err) {
                        console.error("API è«‹æ±‚å¤±æ•—:", err);
                        this.error = "ç„¡æ³•å¾ä¸­å¤®æ°£è±¡ç½²ä¼ºæœå™¨ç²å–è³‡æ–™ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚";
                    } finally {
                        this.isLoading = false;
                    }
                },
                async fetchRainObservation() {
                    // 1. ä¿®æ”¹ï¼šå³æ™‚é›¨é‡å€’æ•¸é‡è¨­ç‚º 300 ç§’ (5åˆ†é˜)
                    this.rainCountdown = 300;

                    try {
                        const response = await axios.get(this.rainApiUrl);

                        // 2. ä¿®æ­£ï¼šè£œå›ä¹‹å‰éºæ¼çš„ Past24hr èˆ‡ ObsTime æ¬„ä½ï¼Œç¢ºä¿ HTML ä¸æœƒå ±éŒ¯
                        this.rainObservation = response.data.records.Station.map(s => ({
                            StationId: s.StationId,
                            TownName: s.GeoInfo.TownName,
                            StationName: s.StationName,
                            Past10Min: s.RainfallElement.Past10Min.Precipitation,
                            Past1hr: s.RainfallElement.Past1hr.Precipitation,
                            Past24hr: s.RainfallElement.Past24hr.Precipitation,
                            ObsTime: s.ObsTime.DateTime
                        }));

                        // ç°¡å–®æª¢æŸ¥é›¨é‡ç«™æ˜¯å¦é”æ¨™ (ç¶­æŒåŸé‚è¼¯)
                        const alertStations = this.rainObservation.filter(s => parseFloat(s.Past10Min) >= 0.5);
                        if (alertStations.length > 0) {
                            this.immediateAlertMessage = alertStations.map(s => s.TownName + "æ¸¬ç«™éŒ„å¾—é™é›¨").join('ï¼›');
                        } else {
                            this.immediateAlertMessage = null;
                        }
                    } catch (err) {
                        console.error("å³æ™‚é›¨é‡ API è«‹æ±‚å¤±æ•—:", err);
                    }
                },
                processForecastData(data) {
                    const now = new Date();
                    const raw = data.records.Locations[0].Location;
                    this.locations = raw.map(loc => {
                        const pop = loc.WeatherElement.find(e => e.ElementName === '3å°æ™‚é™é›¨æ©Ÿç‡').Time;
                        const temp = loc.WeatherElement.find(e => e.ElementName === 'æº«åº¦').Time;
                        const wx = loc.WeatherElement.find(e => e.ElementName === 'å¤©æ°£ç¾è±¡').Time;

                        const forecasts = pop.map(p => {
                            const t = temp.find(item => item.DataTime === p.StartTime);
                            const w = wx.find(item => item.StartTime === p.StartTime);
                            return {
                                startTime: p.StartTime,
                                pop: p.ElementValue[0].ProbabilityOfPrecipitation,
                                temp: t ? t.ElementValue[0].Temperature : 'N/A',
                                rainLevel: this.getRainLevel(w ? w.ElementValue[0].WeatherCode : '0')
                            };
                        }).filter(f => new Date(f.startTime) >= now);
                        return { name: loc.LocationName, forecasts };
                    });
                },
                checkForecastAlert(locations) {
                    if (!this.isAudioEnabled) return;
                    let msgs = [];
                    locations.forEach(l => {
                        const next = l.forecasts[0];
                        if (next && next.rainLevel >= 2 && next.pop >= 50) {
                            msgs.push(`${l.name}é è¨ˆå³å°‡æœ‰é¡¯è‘—é™é›¨ã€‚`);
                        }
                    });
                    if (msgs.length > 0) {
                        this.forecastAlertMessage = msgs.join(' ');
                    } else { this.forecastAlertMessage = null; }
                },
                renderAllCharts() {
                    this.locations.forEach(loc => {
                        const ctxChart = document.getElementById('chart-' + loc.name);
                        const ctxRain = document.getElementById('rain-chart-' + loc.name);
                        if (!ctxChart || !ctxRain) return;

                        if (this.chartInstances[loc.name]) this.chartInstances[loc.name].destroy();
                        this.chartInstances[loc.name] = new Chart(ctxChart, {
                            type: 'bar',
                            data: {
                                labels: loc.forecasts.map(f => this.formatTime(f.startTime)),
                                datasets: [
                                    { type: 'line', label: 'æº«åº¦ (Â°C)', data: loc.forecasts.map(f => f.temp), borderColor: '#f44336', yAxisID: 'y' },
                                    { type: 'bar', label: 'é™é›¨ç‡ (%)', data: loc.forecasts.map(f => f.pop), backgroundColor: 'rgba(33, 150, 243, 0.5)', yAxisID: 'y1' }
                                ]
                            },
                            options: {
                                responsive: true, maintainAspectRatio: false,
                                scales: { y: { position: 'left' }, y1: { position: 'right', max: 100, grid: { drawOnChartArea: false } } }
                            }
                        });
                        if (this.rainChartInstances[loc.name]) this.rainChartInstances[loc.name].destroy();
                        this.rainChartInstances[loc.name] = new Chart(ctxRain, {
                            type: 'line',
                            data: {
                                labels: loc.forecasts.slice(0, 8).map(f => this.formatTime(f.startTime)),
                                datasets: [{ label: 'å¼·åº¦ç´šåˆ¥', data: loc.forecasts.slice(0, 8).map(f => f.rainLevel), borderColor: '#2196f3', stepped: true, fill: true, backgroundColor: 'rgba(33, 150, 243, 0.1)' }]
                            },
                            options: {
                                responsive: true, maintainAspectRatio: false,
                                scales: { y: { min: 0, max: 4, ticks: { stepSize: 1, callback: v => this.rainLevelsText[v] } } }
                            }
                        });
                    });
                },
                // --- è²éŸ³æ§åˆ¶ç³»çµ± ---
                enableAudio() {
                    Tone.start().then(() => {
                        this.isAudioEnabled = true;
                        this.loadSpeechVoices();
                        this.playAlertSound();
                        this.closeTour();
                    });
                },
                loadSpeechVoices() {
                    speechSynthesis.onvoiceschanged = () => {
                        const v = speechSynthesis.getVoices();
                        this.selectedVoice = v.find(i => i.name === 'Google ä¸­æ–‡ (è‡ºç£)') || v.find(i => i.lang === 'zh-TW');
                    };
                    if (speechSynthesis.getVoices().length > 0) speechSynthesis.onvoiceschanged();
                },
                playAlertSound() {
                    const synth = new Tone.Synth().toDestination();
                    const now = Tone.now();
                    synth.triggerAttackRelease("G4", "16n", now);
                    synth.triggerAttackRelease("B4", "16n", now + 0.1);
                    synth.triggerAttackRelease("D5", "16n", now + 0.2);
                },

                speakAlert(msg) {
                    if (!this.isAudioEnabled || !this.selectedVoice) return;
                    window.speechSynthesis.cancel();
                    const u = new SpeechSynthesisUtterance(msg);
                    u.voice = this.selectedVoice;
                    window.speechSynthesis.speak(u);
                },
                getRainLevel(code) {
                    const c = parseInt(code);
                    if (c === 41) return 4;
                    if ([33, 34, 35, 36, 39, 42].includes(c)) return 3;
                    if ([13, 14, 15, 16, 17, 18, 21, 22].includes(c)) return 2;
                    if ([8, 9, 10, 11, 12, 19, 20, 29, 30, 31, 32].includes(c)) return 1;
                    return 0;
                },

                formatTime: s => new Date(s).toLocaleTimeString('zh-TW', { hour: '2-digit', minute: '2-digit', hour12: false }),
                formatFullDateTime: s => new Date(s).toLocaleString('zh-TW', { month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit', hour12: false }),

                startTour() {
                    this.$nextTick(() => {
                        const rect = this.$refs.enableAudioButtonRef?.getBoundingClientRect();
                        if (rect) this.tooltipStyle = { top: (rect.bottom + 15) + 'px', left: (rect.left - 50) + 'px' };
                    });
                },
                closeTour() { this.showOnboarding = false; },
                clearImmediateAlert() { this.immediateAlertMessage = null; },
                clearForecastAlert() { this.forecastAlertMessage = null; }
            },
            mounted() {
                this.startTour();
                this.fetchWeatherData();
                this.fetchRainObservation();
                this.fetchRadarData();

                // æ›´æ–°è¨ˆæ™‚å™¨ (æ¯ç§’æ‰£1) - ç¶­æŒä¸è®Š
                setInterval(() => { if (this.countdown > 0) this.countdown--; }, 1000);
                setInterval(() => { if (this.rainCountdown > 0) this.rainCountdown--; }, 1000);

                // è‡ªå‹•æ›´æ–°æ’ç¨‹ (ä¿®æ”¹è™•ï¼šå…¨éƒ¨çµ±ä¸€ç‚º 300000)
                setInterval(() => this.fetchWeatherData(), 300000);     // é å ±ï¼šåŸ 3600000 -> æ”¹ 300000
                setInterval(() => this.fetchRainObservation(), 300000); // é›¨é‡ï¼šåŸ 600000 -> æ”¹ 300000
                setInterval(() => this.fetchRadarData(), 300000);       // é›·é”ï¼šç¶­æŒ 300000
            }
        }).mount('#app');
    </script>
</body>

</html>