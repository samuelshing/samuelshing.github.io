<!DOCTYPE html>
<html lang="zh-Hant">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>新北市天氣預報與即時雨量</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">

    <!-- 引入 Tone.js 用於播放音效 -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.7.77/Tone.js"></script>

    <style>
        body {
            background-color: #f8f9fa;
        }

        #app {
            max-width: 1200px;
            margin: auto;
            padding: 1rem;
        }

        .location-section {
            background-color: white;
            padding: 2rem;
            border-radius: 0.5rem;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        }

        .chart-container,
        .rain-chart-container {
            position: relative;
            height: 40vh;
            min-height: 300px;
        }

        .weather-card {
            transition: transform 0.2s;
        }

        .weather-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        .weather-icon {
            font-size: 3rem;
            color: #0d6efd;
        }

        /* 即時雨量卡片樣式 */
        .realtime-rain-card {
            background-color: #ffffff;
            border: 1px solid #dee2e6;
            border-radius: 0.375rem;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }
    </style>
</head>

<body>
    <!-- <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container">
            <a class="navbar-brand" href="./index.html">
                <i class="bi bi-code-slash"></i>
                功能入口
            </a>
        </div>
    </nav> -->

    <div id="app">
        <header class="text-center my-4">
            <h1 class="display-5 fw-bold">🏙️ 新北市天氣預報與即時雨量</h1>
            <p class="text-muted">（新店區、中和區、板橋區預報｜新北、中和、板橋觀測站即時資料）</p>
        </header>

        <div v-if="isLoading" class="text-center my-5">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p class="mt-2">正在載入天氣資料...</p>
        </div>

        <div v-if="error" class="alert alert-danger" role="alert">
            <i class="bi bi-exclamation-triangle-fill"></i>
            <strong>資料載入失敗：</strong> {{ error }}
        </div>

        <main v-if="!isLoading && !error" class="d-flex flex-column gap-4">
            <!-- 即時雨量觀測區塊 -->
            <section>
                <h2 class="text-center mb-3">💧 即時雨量觀測</h2>

                <!-- 即時降雨警示 -->
                <div v-if="immediateAlertMessage" class="alert alert-danger alert-dismissible fade show mt-3"
                     role="alert" style="max-width: 800px; margin-left: auto; margin-right: auto;">
                    <i class="bi bi-exclamation-triangle-fill me-2"></i>
                    <strong>即時降雨警示：</strong> {{ immediateAlertMessage }}
                    <button type="button" class="btn-close" @click="clearImmediateAlert"></button>
                </div>

                <p class="text-center text-primary fw-bold" v-if="rainObservation.length > 0">
                    <i class="bi bi-arrow-clockwise"></i>
                    API資料每10分鐘更新，將於 {{ rainCountdownMinutes }} 分 {{ rainCountdownSeconds }} 秒後更新即時資料...
                </p>
                <div v-if="rainObservation.length > 0" class="row g-4">
                    <div v-for="station in rainObservation" :key="station.StationId" class="col-md-4">
                        <div class="p-3 realtime-rain-card h-100 d-flex flex-column">
                            <h5 class="mb-3">{{ station.TownName }}</h5>
                            <ul class="list-group list-group-flush flex-grow-1">
                                <li class="list-group-item d-flex justify-content-between align-items-center">
                                    10分鐘雨量
                                    <span class="badge bg-primary rounded-pill fs-6">{{ station.Past10Min }} mm</span>
                                </li>
                                <li class="list-group-item d-flex justify-content-between align-items-center">
                                    1小時雨量
                                    <span class="badge bg-secondary rounded-pill fs-6">{{ station.Past1hr }} mm</span>
                                </li>
                                <li class="list-group-item d-flex justify-content-between align-items-center">
                                    24小時雨量
                                    <span class="badge bg-secondary rounded-pill fs-6">{{ station.Past24hr }} mm</span>
                                </li>
                            </ul>
                            <small class="text-muted mt-3 d-block text-center">
                                觀測時間: {{ formatFullDateTime(station.ObsTime) }}
                            </small>
                        </div>
                    </div>
                </div>
                <div v-else class="text-center text-muted">
                    <div class="spinner-border spinner-border-sm text-primary" role="status"></div>
                    正在載入即時雨量資料...
                </div>
            </section>

            <!-- 天氣預報區塊 -->
            <section class="location-section">
                <h2 class="text-center mb-3">🌦️ 未來24小時天氣預報</h2>

                <!-- 降雨預報警示 -->
                <div v-if="forecastAlertMessage" class="alert alert-warning alert-dismissible fade show mt-3"
                     role="alert" style="max-width: 800px; margin-left: auto; margin-right: auto;">
                    <i class="bi bi-clock-fill me-2"></i>
                    <strong>降雨預報警示：</strong> {{ forecastAlertMessage }}
                    <button type="button" class="btn-close" @click="clearForecastAlert"></button>
                </div>

                <!-- 倒數計時器 -->
                <p class="text-center text-success fw-bold" v-if="!isLoading && !error">
                    <i class="bi bi-arrow-clockwise"></i>
                    預報將於 {{ countdownMinutes }} 分 {{ countdownSeconds }} 秒後自動更新...
                </p>

                <!-- 更新時間設定 -->
                <div class="d-flex justify-content-center align-items-center mt-2 gap-2">
                    每
                    <input type="number" class="form-control" v-model.number="newCountdownValue" min="1" placeholder="秒數" style="width: 100px;">
                    秒更新資訊
                    <button class="btn btn-secondary btn-sm" @click="applyNewCountdown">設定</button>
                    <!-- 啟用音訊按鈕 -->
                    <button class="btn btn-info btn-sm" @click="enableAudio" v-if="!isAudioEnabled">
                        <i class="bi bi-bell-fill"></i> 啟用聲音警示
                    </button>
                    <span v-if="isAudioEnabled" class="text-success small"><i class="bi bi-check-circle-fill"></i> 聲音已啟用</span>
                </div>
                <!-- 聲音說明 -->
                <small v-if="!isAudioEnabled" class="text-center text-muted d-block mt-2">* 請點擊「啟用聲音警示」以允許瀏覽器播放即時警示音效與語音。</small>
                <!-- 預報圖表 (v-for) -->
                <div v-for="location in locations" :key="location.name" class="mt-5">
                    <h3 class="mb-4 display-6 border-bottom pb-2">{{ location.name }}</h3>
                    <div class="row">
                        <div class="col-lg-4">
                            <h4 class="h5 text-muted">降雨趨勢</h4>
                            <div class="rain-chart-container mb-5">
                                <canvas :id="'rain-chart-' + location.name"></canvas>
                            </div>
                        </div>
                        <div class="col-lg-8">
                            <h4 class="h5 text-muted">綜合天氣趨勢</h4>
                            <div class="chart-container mb-5">
                                <canvas :id="'chart-' + location.name"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            </section>
        </main>
        <footer class="text-center text-muted mt-5">
            <p>資料來源：<a href="https://opendata.cwa.gov.tw/" target="_blank">交通部中央氣象署</a></p>
            <p>資料API：
                <a href="https://opendata.cwa.gov.tw/dist/opendata-swagger.html#/%E9%A0%90%E5%A0%B1/get_v1_rest_datastore_F_D0047_069" target="_blank">天氣預報</a> |
                <a href="https://opendata.cwa.gov.tw/dist/opendata-swagger.html#/%E8%A7%80%E6%B8%AC/get_v1_rest_datastore_O_A0002_001" target="_blank">雨量觀測</a>
            </p>
        </footer>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/vue@3/dist/vue.global.prod.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <script>
        const { createApp } = Vue;

        window.app = createApp({
            data() {
                return {
                    // 預報 API (F-D0047-069)
                    forecastApiUrl: 'https://opendata.cwa.gov.tw/api/v1/rest/datastore/F-D0047-069?Authorization=CWA-F36D4CE9-10F1-43BA-82E6-8E7DA63697F7&format=JSON&LocationName=新店區,中和區,板橋區&ElementName=3小時降雨機率,溫度,天氣現象,體感溫度',
                    // 即時雨量 API (O-A0002-001)
                    rainApiUrl: 'https://opendata.cwa.gov.tw/api/v1/rest/datastore/O-A0002-001?Authorization=CWA-F36D4CE9-10F1-43BA-82E6-8E7DA63697F7&format=JSON&StationId=466881,C0AG80,C0AJ80',

                    isLoading: true,
                    error: null,

                    // 預報資料
                    locations: [],
                    chartInstances: {},
                    rainChartInstances: {},

                    // 即時雨量資料
                    rainObservation: [], // 儲存多個觀測站
                    rainInterval: null,
                    rainCountdown: 600, // 10 分鐘
                    rainCountdownInterval: null, // 即時雨量計時器

                    previousRain10Min: {}, // 儲存 { 'StationId': 0.0 }

                    // 預報計時器
                    countdown: 3600,
                    dataInterval: null,
                    countdownInterval: null,
                    newCountdownValue: 3600,
                    activeCountdownSetting: 3600,

                    // 警示系統
                    isAudioEnabled: false,
                    // 【*** 修改 ***】 拆分警示訊息
                    immediateAlertMessage: null, // 即時警示
                    forecastAlertMessage: null, // 預報警示
                    immediateAlertTimer: null, // 即時警示的計時器
                    forecastAlertTimer: null, // 預報警示的計時器

                    // 語音系統
                    speechVoices: [],
                    selectedVoice: null,
                    rainLevelsText: ['無雨', '小雨', '中雨', '大雨', '暴雨'],
                };
            },
            computed: {
                countdownMinutes() {
                    return Math.floor(this.countdown / 60);
                },
                countdownSeconds() {
                    return (this.countdown % 60).toString().padStart(2, '0');
                },
                rainCountdownMinutes() {
                    return Math.floor(this.rainCountdown / 60);
                },
                rainCountdownSeconds() {
                    return (this.rainCountdown % 60).toString().padStart(2, '0');
                }
            },
            methods: {
                // --- 主要資料獲取 ---
                async fetchWeatherData() {
                    // 預報倒數重設
                    this.countdown = this.activeCountdownSetting;
                    try {
                        const response = await axios.get(this.forecastApiUrl);
                        if (response.data.success !== "true") {
                            throw new Error('API 回應錯誤');
                        }
                        this.processData(response.data);

                        // 檢查降雨預報
                        this.checkRainAlert(this.locations);

                        // 確保 DOM 渲染完畢
                        this.$nextTick(() => {
                            this.$nextTick(() => {
                                this.renderAllCharts();
                            });
                        });
                    } catch (err) {
                        console.error("API 請求失敗:", err);
                        this.error = "無法從中央氣象署伺服器獲取資料，請稍後再試。";
                    } finally {
                        this.isLoading = false;
                    }
                },
                async fetchRainObservation() {
                    // 即時雨量倒數重設
                    this.rainCountdown = 600;
                    try {
                        // 儲存前一次的雨量值
                        if (this.rainObservation.length > 0) {
                            this.rainObservation.forEach(station => {
                                this.previousRain10Min[station.StationId] = parseFloat(station.Past10Min);
                            });
                        }
                        const response = await axios.get(this.rainApiUrl);
                        if (response.data.success !== "true" || !response.data.records.Station) {
                            throw new Error('即時雨量 API 回應錯誤');
                        }

                        this.rainObservation = response.data.records.Station.map(station => {
                            return {
                                StationName: station.StationName,
                                StationId: station.StationId,
                                TownName: station.GeoInfo.TownName,
                                ObsTime: station.ObsTime.DateTime,
                                Past10Min: station.RainfallElement.Past10Min.Precipitation,
                                Past1hr: station.RainfallElement.Past1hr.Precipitation,
                                Past24hr: station.RainfallElement.Past24hr.Precipitation,
                            };
                        });
                        // 檢查即時雨量警示
                        this.checkImmediateRainAlert(this.rainObservation);
                    } catch (err) {
                        console.error("即時雨量 API 請求失敗:", err);
                    }
                },
                // --- 資料處理與圖表 ---
                processData(data) {
                    const currentTime = new Date();
                    const twentyFourHoursLater = new Date(currentTime.getTime() + 24 * 60 * 60 * 1000);
                    const rawLocations = data.records.Locations[0].Location;
                    this.locations = rawLocations.map(location => {
                        const tempElement = location.WeatherElement.find(el => el.ElementName === '溫度').Time;
                        const apparentTempElement = location.WeatherElement.find(el => el.ElementName === '體感溫度').Time;
                        const popElement = location.WeatherElement.find(el => el.ElementName === '3小時降雨機率').Time;
                        const weatherElement = location.WeatherElement.find(el => el.ElementName === '天氣現象').Time;
                        const allForecasts = popElement.map(popTime => {
                            const startTime = popTime.StartTime;
                            const currentTemp = tempElement.find(t => t.DataTime === startTime);
                            const currentApparentTemp = apparentTempElement.find(t => t.DataTime === startTime);
                            const currentWx = weatherElement.find(wx => wx.StartTime === startTime);
                            const weatherCode = currentWx ? currentWx.ElementValue[0].WeatherCode : '0';
                            return {
                                startTime: startTime, endTime: popTime.EndTime,
                                pop: popTime.ElementValue[0].ProbabilityOfPrecipitation,
                                temp: currentTemp ? currentTemp.ElementValue[0].Temperature : 'N/A',
                                apparentTemp: currentApparentTemp ? currentApparentTemp.ElementValue[0].ApparentTemperature : 'N/A',
                                weather: currentWx ? currentWx.ElementValue[0].Weather : 'N/A',
                                weatherCode: weatherCode,
                                rainLevel: this.getRainLevel(weatherCode)
                            };
                        });
                        const forecasts = allForecasts.filter(forecast => {
                            const forecastTime = new Date(forecast.startTime);
                            return forecastTime >= currentTime && forecastTime < twentyFourHoursLater;
                        });
                        return { name: location.LocationName, forecasts };
                    });
                },
                renderAllCharts() {
                    this.locations.forEach(location => {
                        this.renderWeatherChart(location);
                        this.renderRainChart(location);
                    });
                },
                renderWeatherChart(location) {
                    const canvasId = 'chart-' + location.name;
                    const ctx = document.getElementById(canvasId);
                    if (!ctx) return;
                    if (this.chartInstances[location.name]) this.chartInstances[location.name].destroy();
                    const forecasts = location.forecasts;
                    this.chartInstances[location.name] = new Chart(ctx.getContext('2d'), {
                        type: 'bar',
                        data: {
                            labels: forecasts.map(f => this.formatDate(f.startTime) + ' ' + this.formatTime(f.startTime)),
                            datasets: [
                                { type: 'line', label: '溫度 (°C)', data: forecasts.map(f => f.temp), borderColor: 'rgba(255, 99, 132, 1)', yAxisID: 'y-temp', tension: 0.3 },
                                { type: 'line', label: '體感溫度 (°C)', data: forecasts.map(f => f.apparentTemp), borderColor: 'rgba(255, 159, 64, 1)', yAxisID: 'y-temp', tension: 0.3, borderDash: [5, 5] },
                                { type: 'bar', label: '降雨機率 (%)', data: forecasts.map(f => f.pop), backgroundColor: 'rgba(54, 162, 235, 0.5)', yAxisID: 'y-pop' },
                            ]
                        },
                        options: {
                            responsive: true, maintainAspectRatio: false,
                            interaction: { mode: 'index', intersect: false },
                            scales: {
                                'y-temp': { type: 'linear', position: 'left', title: { display: true, text: '溫度 (°C)' } },
                                'y-pop': { type: 'linear', position: 'right', min: 0, max: 100, title: { display: true, text: '降雨機率 (%)' }, grid: { drawOnChartArea: false } }
                            }
                        }
                    });
                },
                renderRainChart(location) {
                    const canvasId = 'rain-chart-' + location.name;
                    const ctx = document.getElementById(canvasId);
                    if (!ctx) return;
                    if (this.rainChartInstances[location.name]) this.rainChartInstances[location.name].destroy();
                    const rainForecasts = location.forecasts.slice(0, 8);
                    this.rainChartInstances[location.name] = new Chart(ctx.getContext('2d'), {
                        type: 'line',
                        data: {
                            labels: rainForecasts.map(f => this.formatDate(f.startTime) + ' ' + this.formatTime(f.startTime)),
                            datasets: [{
                                label: '降雨等級',
                                data: rainForecasts.map(f => f.rainLevel),
                                borderColor: 'rgba(75, 192, 192, 1)',
                                backgroundColor: 'rgba(75, 192, 192, 0.2)',
                                stepped: true,
                                fill: true,
                            }]
                        },
                        options: {
                            responsive: true, maintainAspectRatio: false,
                            plugins: { legend: { display: false } },
                            scales: {
                                y: {
                                    min: 0, max: 4,
                                    ticks: {
                                        stepSize: 1,
                                        callback: (value) => this.rainLevelsText[value]
                                    }
                                }
                            }
                        }
                    });
                },
                // --- 計時器與設定 ---
                applyNewCountdown() {
                    this.error = null;
                    if (!this.newCountdownValue || this.newCountdownValue < 1) {
                        this.error = "輸入秒數無效，已重設為預設值 3600 秒。";
                        this.activeCountdownSetting = 3600;
                        this.newCountdownValue = 3600;
                        this.fetchWeatherData(); // 立即 request
                    } else {
                        this.activeCountdownSetting = this.newCountdownValue;
                    }
                    Tone.start();
                    this.countdown = this.activeCountdownSetting;
                    clearInterval(this.dataInterval);
                    this.dataInterval = setInterval(() => {
                        this.fetchWeatherData();
                    }, this.activeCountdownSetting * 1000);
                },
                startCountdownTicker() {
                    if (this.countdownInterval) clearInterval(this.countdownInterval);
                    this.countdownInterval = setInterval(() => {
                        if (this.countdown > 0) this.countdown--;
                    }, 1000);
                },
                startRainCountdownTicker() {
                    if (this.rainCountdownInterval) clearInterval(this.rainCountdownInterval);
                    this.rainCountdownInterval = setInterval(() => {
                        if (this.rainCountdown > 0) this.rainCountdown--;
                    }, 1000);
                },
                // --- 聲音與警示系統 ---
                async enableAudio() {
                    try {
                        await Tone.start();
                        this.isAudioEnabled = true;
                        this.loadSpeechVoices(); // 載入語音包
                        this.playAlertSound(); // 播放測試音
                        console.log("音訊已由使用者啟用。");
                        if (Tone.Transport.state !== "started") {
                            Tone.Transport.start();
                        }
                    } catch (e) {
                        console.error("啟用音訊失敗:", e);
                        this.error = "瀏覽器限制，無法啟用音訊。";
                    }
                },
                loadSpeechVoices() {
                    // 非同步載入語音
                    speechSynthesis.onvoiceschanged = () => {
                        this.speechVoices = speechSynthesis.getVoices();
                        // 優先 (1): Google 中文 (臺灣)
                        this.selectedVoice = this.speechVoices.find(voice => voice.name === 'Google 中文 (臺灣)');
                        // 其次 (2): 任何臺灣中文
                        if (!this.selectedVoice) {
                            this.selectedVoice = this.speechVoices.find(voice => voice.lang === 'zh-TW');
                        }
                        // 最後 (3): 任何中文
                        if (!this.selectedVoice) {
                            this.selectedVoice = this.speechVoices.find(voice => voice.lang.startsWith('zh'));
                        }
                        console.log("選定的語音:", this.selectedVoice ? this.selectedVoice.name : '未找到中文語音');
                    };
                    // 立即觸發一次載入 (針對某些瀏覽器)
                    this.speechVoices = speechSynthesis.getVoices();
                    if (this.speechVoices.length > 0) {
                        speechSynthesis.onvoiceschanged(); // 手動觸發
                    }
                },
                playAlertSound() {
                    if (!this.isAudioEnabled) return;
                    try {
                        const synth = new Tone.Synth().toDestination();
                        const now = Tone.now();
                        // 0.5 秒內播放 3 次 C5
                        synth.triggerAttackRelease("C5", "16n", now);
                        synth.triggerAttackRelease("C5", "16n", now + 0.15);
                        synth.triggerAttackRelease("C5", "16n", now + 0.3);
                        // 確保 Tone.Transport 正在運行
                        if (Tone.Transport.state !== "started") {
                            Tone.Transport.start();
                        }
                    } catch (e) {
                        console.error("播放聲音失敗:", e);
                    }
                },
                speakAlert(message) {
                    if (!this.isAudioEnabled || !this.selectedVoice) {
                        console.log("語音未啟用或未找到語音包，取消播放。");
                        return;
                    }
                    // 先停止目前可能正在播放的語音
                    window.speechSynthesis.cancel();
                    const utterance = new SpeechSynthesisUtterance(message);
                    utterance.voice = this.selectedVoice;
                    utterance.lang = this.selectedVoice.lang;
                    utterance.rate = 1.0;
                    window.speechSynthesis.speak(utterance);
                },
                showImmediateAlert(message) {
                    this.immediateAlertMessage = message;
                    // 清除舊的計時器
                    if (this.immediateAlertTimer) clearTimeout(this.immediateAlertTimer);
                    // 60 秒後自動清除
                    this.immediateAlertTimer = setTimeout(() => {
                        this.immediateAlertMessage = null;
                    }, 60000);
                },
                showForecastAlert(message) {
                    this.forecastAlertMessage = message;
                    if (this.forecastAlertTimer) clearTimeout(this.forecastAlertTimer);
                    // 60 秒後自動清除
                    this.forecastAlertTimer = setTimeout(() => {
                        this.forecastAlertMessage = null;
                    }, 60000);
                },
                // 清除警示的方法 (給 X 按鈕用)
                clearImmediateAlert() {
                    this.immediateAlertMessage = null;
                    if (this.immediateAlertTimer) clearTimeout(this.immediateAlertTimer);
                    window.speechSynthesis.cancel();
                },
                clearForecastAlert() {
                    this.forecastAlertMessage = null;
                    if (this.forecastAlertTimer) clearTimeout(this.forecastAlertTimer);
                    window.speechSynthesis.cancel();
                },
                // 即時警示邏輯
                checkImmediateRainAlert(observations) {
                    if (!this.isAudioEnabled) return;
                    const alertThreshold = 0.5;
                    let alertMessages = [];
                    for (const station of observations) {
                        const rain10Min = parseFloat(station.Past10Min);
                        const previousRain10Min = this.previousRain10Min[station.StationId] || 0.0;

                        if (rain10Min >= alertThreshold && previousRain10Min < alertThreshold) {
                            const message = `${station.StationName} (${station.TownName}) 10分鐘雨量 ${rain10Min} 毫米。`;
                            alertMessages.push(message);
                        }
                    }
                    if (alertMessages.length > 0) {
                        // 僅在 *目前沒有* 即時警示時才觸發聲音和語音
                        if (!this.immediateAlertMessage) {
                            const fullAlertMessage = alertMessages.join(' ');
                            this.playAlertSound();
                            setTimeout(() => this.speakAlert("即時警示：" + fullAlertMessage), 500); // 聲音後 0.5 秒
                        }
                        // 無論如何都更新警示文字
                        this.showImmediateAlert(alertMessages.join(' '));
                    } else {
                        // 如果所有觀測站的雨都停了 (< 0.5)，則清除即時警示
                        this.clearImmediateAlert();
                    }
                },
                // 預報警示邏輯
                checkRainAlert(locations) {
                    if (!this.isAudioEnabled) return;
                    // 如果「即時警示」正在顯示，則暫停「預報警示」，避免重複
                    if (this.immediateAlertMessage) return;
                    let alertMessages = [];
                    const rainLevels = this.rainLevelsText;
                    for (const location of locations) {
                        if (!location.forecasts || location.forecasts.length < 2) continue;
                        const currentRainLevel = location.forecasts[0].rainLevel;
                        const nextRainLevel = location.forecasts[1].rainLevel;
                        const nextStartTime = this.formatTime(location.forecasts[1].startTime);
                        let reason = null;
                        if (currentRainLevel === 0 && nextRainLevel > 0) {
                            reason = `${location.name} 預計 ${nextStartTime} 將轉為 ${rainLevels[nextRainLevel]}。`;
                        }
                        else if (nextRainLevel > currentRainLevel && currentRainLevel > 0) {
                            reason = `${location.name} 預計 ${nextStartTime} 雨勢將增強為 ${rainLevels[nextRainLevel]}。`;
                        }
                        if (reason) {
                            alertMessages.push(reason);
                        }
                    }
                    if (alertMessages.length > 0) {
                        // 僅在 *目前沒有* 預報警示時才觸發聲音和語音
                        if (!this.forecastAlertMessage) {
                            const fullAlertMessage = alertMessages.join(' ');
                            this.playAlertSound();
                            // 預報警示的聲音延遲久一點
                            setTimeout(() => this.speakAlert("預報警 ..." + fullAlertMessage), 5000);
                        }
                        // 無論如何都更新文字
                        this.showForecastAlert(alertMessages.join(' '));
                    } else {
                        // 如果沒有預報了，清除舊的預報
                        this.clearForecastAlert();
                    }
                },
                // --- 格式化工具 ---
                getRainLevel(weatherCode) {
                    const code = parseInt(weatherCode);
                    // 根據氣象局定義：
                    // 41 (大雷雨)
                    if ([41].includes(code)) return 4; // 暴雨
                    // 33, 34, 35, 36 (雷雨/陣雨/冰雹), 39(大雨), 42(豪雨)
                    if ([33, 34, 35, 36, 39, 42].includes(code)) return 3; // 大雨
                    // 13, 14, 15, 16, 17, 18, 21, 22 (雷/陣雨)
                    if ([13, 14, 15, 16, 17, 18, 21, 22].includes(code)) return 2; // 中雨
                    // 8-12 (小雨/陣雨), 19,20(雨), 29-32(雨)
                    if ([8, 9, 10, 11, 12, 19, 20, 29, 30, 31, 32].includes(code)) return 1; // 小雨
                    return 0; // 無雨 (1-7, 24-28 等)
                },

                formatTime(dateTimeStr) {
                    return new Date(dateTimeStr).toLocaleTimeString('zh-TW', { hour: '2-digit', minute: '2-digit', hour12: false });
                },
                formatDate(dateTimeStr) {
                    return new Date(dateTimeStr).toLocaleDateString('zh-TW', { month: '2-digit', day: '2-digit' });
                },
                formatFullDateTime(dateTimeStr) {
                    const d = new Date(dateTimeStr);
                    const date = d.toLocaleDateString('zh-TW', { month: '2-digit', day: '2-digit' });
                    const time = d.toLocaleTimeString('zh-TW', { hour: '2-digit', minute: '2-digit', hour12: false });
                    return `${date} ${time}`;
                },
                getWeatherIconClass(code) {
                    const codeNum = parseInt(code);
                    if ([15, 16, 17, 18, 21, 22, 33, 34, 35, 36, 41].includes(codeNum)) return 'bi bi-cloud-lightning-rain-fill';
                    if ([8, 9, 10, 11, 12, 13, 14, 19, 20, 29, 30, 31, 32, 38, 39].includes(codeNum)) return 'bi bi-cloud-drizzle-fill';
                    if ([24, 25, 26, 27, 28].includes(codeNum)) return 'bi bi-cloud-fog2-fill';
                    if ([4, 5, 6, 7].includes(codeNum)) return 'bi bi-clouds-fill';
                    if (codeNum === 1) return 'bi bi-brightness-high-fill';
                    if ([2, 3].includes(codeNum)) return 'bi bi-cloud-sun-fill';
                    return 'bi bi-cloud-fill';
                }
            },
            mounted() {
                // 立即載入所有資料
                this.fetchWeatherData();
                this.fetchRainObservation();
                // 啟動所有計時器
                this.startCountdownTicker();
                this.startRainCountdownTicker();
                // 設定自動更新
                this.dataInterval = setInterval(() => {
                    this.fetchWeatherData();
                }, this.activeCountdownSetting * 1000);
                this.rainInterval = setInterval(() => {
                    this.fetchRainObservation();
                }, 600 * 1000); // 600 秒 (10分鐘)
            },
            beforeUnmount() {
                // 清除所有圖表
                for (const key in this.chartInstances) this.chartInstances[key].destroy();
                for (const key in this.rainChartInstances) this.rainChartInstances[key].destroy();
                // 清除所有計時器
                clearInterval(this.dataInterval);
                clearInterval(this.countdownInterval);
                clearInterval(this.rainInterval);
                clearInterval(this.rainCountdownInterval);
                // 清除警示計時器
                if (this.immediateAlertTimer) clearTimeout(this.immediateAlertTimer);
                if (this.forecastAlertTimer) clearTimeout(this.forecastAlertTimer);
                // 停止語音
                window.speechSynthesis.cancel();
            }
        }).mount('#app');
    </script>

</body>

</html>

