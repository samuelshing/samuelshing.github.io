<!DOCTYPE html>
<html lang="zh-Hant">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ–°åŒ—å¸‚å¤©æ°£é å ±èˆ‡å³æ™‚é›¨é‡</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">

    <!-- å¼•å…¥ Tone.js ç”¨æ–¼æ’­æ”¾éŸ³æ•ˆ -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.7.77/Tone.js"></script>

    <style>
        body {
            background-color: #f8f9fa;
        }

        #app {
            max-width: 1200px;
            margin: auto;
            padding: 1rem;
        }

        .location-section {
            background-color: white;
            padding: 2rem;
            border-radius: 0.5rem;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        }

        .chart-container,
        .rain-chart-container {
            position: relative;
            height: 40vh;
            min-height: 300px;
        }

        .realtime-rain-card {
            background-color: #fff;
            border-radius: 0.5rem;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        }

        .forecast-controls {
            background-color: #f1f3f5;
            padding: 1rem;
            border-radius: 0.5rem;
        }
    </style>
</head>

<body>
    <!-- <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container">
            <a class="navbar-brand" href="./index.html">
                <i class="bi bi-code-slash"></i>
                åŠŸèƒ½å…¥å£
            </a>
        </div>
    </nav> -->

    <div id="app">
        <header class="text-center my-4">
            <h1 class="display-5 fw-bold">ğŸ™ï¸ æ–°åŒ—å¸‚å¤©æ°£é å ±èˆ‡å³æ™‚é›¨é‡</h1>
            <p class="text-muted">ï¼ˆæ–°åº—å€ã€ä¸­å’Œå€ã€æ¿æ©‹å€é å ±ï½œæ–°åŒ—æ–°åº—è§€æ¸¬ç«™å³æ™‚è³‡æ–™ï¼‰</p>

            <!-- è­¦ç¤ºè¨Šæ¯æ¡† -->
            <div v-if="alertMessage" :class="alertType === 'immediate' ? 'alert-danger' : 'alert-warning'"
                 class="alert alert-dismissible fade show mt-3" role="alert"
                 style="max-width: 800px; margin-left: auto; margin-right: auto;">
                <i class="bi bi-exclamation-triangle-fill me-2"></i>
                <strong>{{ alertType === 'immediate' ? 'å³æ™‚é™é›¨è­¦ç¤º' : 'é™é›¨é å ±è­¦ç¤º' }}ï¼š</strong>
                {{ alertMessage }}
                <button type="button" class="btn-close" @click="alertMessage = null; alertType = null;"></button>
            </div>
        </header>

        <div v-if="isLoading" class="text-center my-5">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p class="mt-2">æ­£åœ¨è¼‰å…¥å¤©æ°£è³‡æ–™...</p>
        </div>

        <div v-if="error" class="alert alert-danger" role="alert">
            <i class="bi bi-exclamation-triangle-fill"></i>
            <strong>è³‡æ–™è¼‰å…¥å¤±æ•—ï¼š</strong> {{ error }}
        </div>

        <main v-if="!isLoading && !error" class="d-flex flex-column gap-4">
            <!-- å³æ™‚é›¨é‡è§€æ¸¬å€å¡Š -->
            <section>
                <h2 class="text-center mb-3">ğŸ’§ å³æ™‚é›¨é‡è§€æ¸¬ æ–°åŒ—æ–°åº—è§€æ¸¬ç«™</h2>
                <!-- ã€*** æ–°å¢ ***ã€‘ å³æ™‚é›¨é‡å€’æ•¸è¨ˆæ™‚ -->
                <p class="text-center text-primary fw-bold" v-if="rainObservation.StationName">
                    <i class="bi bi-arrow-clockwise"></i>
                    å°‡æ–¼ {{ rainCountdownMinutes }} åˆ† {{ rainCountdownSeconds }} ç§’å¾Œè‡ªå‹•æ›´æ–°å³æ™‚è³‡æ–™...
                </p>

                <div v-if="rainObservation.StationName" class="p-4 realtime-rain-card">
                    <div class="row text-center g-3">
                        <div class="col-md-3">
                            <div class="display-6">{{ rainObservation.Past10Min }} <span class="h5">mm</span></div>
                            <div class="text-muted">10åˆ†é˜é›¨é‡</div>
                        </div>
                        <div class="col-md-3">
                            <div class="display-6">{{ rainObservation.Past1hr }} <span class="h5">mm</span></div>
                            <div class="text-muted">1å°æ™‚é›¨é‡</div>
                        </div>
                        <div class="col-md-3">
                            <div class="display-6">{{ rainObservation.Past24hr }} <span class="h5">mm</span></div>
                            <div class="text-muted">24å°æ™‚é›¨é‡</div>
                        </div>
                        <div class="col-md-3">
                            <small class="text-muted">è§€æ¸¬æ™‚é–“ï¼š<br>{{ formatFullDateTime(rainObservation.ObsTime) }}</small>
                        </div>
                    </div>
                </div>
                <div v-else class="text-center text-muted">
                    <div class="spinner-border spinner-border-sm text-primary" role="status"></div>
                    æ­£åœ¨è¼‰å…¥å³æ™‚é›¨é‡è³‡æ–™...
                </div>
            </section>

            <!-- å¤©æ°£é å ±å€å¡Š -->
            <section class="border-top pt-4">
                <h2 class="text-center mb-3">ğŸŒ¦ï¸ æœªä¾†24å°æ™‚å¤©æ°£é å ±</h2>

                <!-- ã€*** ä¿®æ”¹ ***ã€‘ é å ±æ§åˆ¶å€å¡Šç§»è‡³æ­¤è™• -->
                <div class="forecast-controls text-center mb-4">
                    <p class="text-success fw-bold mb-2" v-if="!isLoading && !error">
                        <i class="bi bi-arrow-clockwise"></i>
                        é å ±å°‡æ–¼ {{ countdownMinutes }} åˆ† {{ countdownSeconds }} ç§’å¾Œè‡ªå‹•æ›´æ–°...
                    </p>
                    <div class="d-flex justify-content-center align-items-center mt-2 gap-2">
                        æ¯
                        <input type="number" class="form-control" v-model.number="newCountdownValue" min="1" placeholder="ç§’æ•¸" style="width: 100px;">
                        ç§’æ›´æ–°é å ±
                        <button class="btn btn-secondary btn-sm" @click="applyNewCountdown">è¨­å®š</button>
                        <button class="btn btn-info btn-sm" @click="enableAudio" v-if="!isAudioEnabled">
                            <i class="bi bi-bell-fill"></i> å•Ÿç”¨è²éŸ³è­¦ç¤º
                        </button>
                        <small v-if="!isAudioEnabled" class="text-muted ms-1">(éœ€æ‰‹å‹•å•Ÿç”¨)</small>
                        <span v-if="isAudioEnabled" class="text-success small"><i class="bi bi-check-circle-fill"></i> è²éŸ³å·²å•Ÿç”¨</span>
                    </div>
                </div>

                <div class="d-flex flex-column gap-5">
                    <section v-for="location in locations" :key="location.name" class="location-section">
                        <h2 class="mb-4 display-6 border-bottom pb-2">{{ location.name }}</h2>
                        <div class="row">
                            <div class="col-lg-4">
                                <h3 class="h5 text-muted">é™é›¨è¶¨å‹¢</h3>
                                <div class="rain-chart-container mb-5">
                                    <canvas :id="'rain-chart-' + location.name"></canvas>
                                </div>
                            </div>
                            <div class="col-lg-8">
                                <h3 class="h5 text-muted">ç¶œåˆå¤©æ°£è¶¨å‹¢</h3>
                                <div class="chart-container mb-5">
                                    <canvas :id="'chart-' + location.name"></canvas>
                                </div>
                            </div>
                        </div>
                    </section>
                </div>
            </section>
        </main>

        <footer class="text-center text-muted mt-5">
            <p>è³‡æ–™ä¾†æºï¼š<a href="https://opendata.cwa.gov.tw/" target="_blank">äº¤é€šéƒ¨ä¸­å¤®æ°£è±¡ç½²</a></p>
            <p>ä½¿ç”¨APIï¼š
                <a href="https://opendata.cwa.gov.tw/dist/opendata-swagger.html#/%E9%A0%90%E5%A0%B1/get_v1_rest_datastore_F_D0047_069" target="_blank">é„‰é®å¤©æ°£é å ±</a> |
                <a href="https://opendata.cwa.gov.tw/dist/opendata-swagger.html#/%E8%A7%80%E6%B8%AC/get_v1_rest_datastore_O_A0002_001" target="_blank">è‡ªå‹•é›¨é‡ç«™è³‡æ–™</a>
            </p>
        </footer>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/vue@3/dist/vue.global.prod.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <script>
        const { createApp } = Vue;

        window.app = createApp({
            data() {
                return {
                    // é å ± API (F-D0047-069)
                    forecastApiUrl: 'https://opendata.cwa.gov.tw/api/v1/rest/datastore/F-D0047-069?Authorization=CWA-F36D4CE9-10F1-43BA-82E6-8E7DA63697F7&format=JSON&LocationName=æ–°åº—å€,ä¸­å’Œå€,æ¿æ©‹å€&ElementName=3å°æ™‚é™é›¨æ©Ÿç‡,æº«åº¦,å¤©æ°£ç¾è±¡,é«”æ„Ÿæº«åº¦',
                    // å³æ™‚é›¨é‡ API (O-A0002-001)
                    rainApiUrl: 'https://opendata.cwa.gov.tw/api/v1/rest/datastore/O-A0002-001?Authorization=CWA-F36D4CE9-10F1-43BA-82E6-8E7DA63697F7&format=JSON&StationId=466881',

                    isLoading: true,
                    error: null,

                    // é å ±è³‡æ–™
                    locations: [],
                    chartInstances: {},
                    rainChartInstances: {},

                    // å³æ™‚é›¨é‡è³‡æ–™
                    rainObservation: {},
                    rainInterval: null,
                    rainCountdown: 600, // ã€*** æ–°å¢ ***ã€‘ å³æ™‚é›¨é‡å€’æ•¸ (ç§’)
                    rainCountdownInterval: null, // ã€*** æ–°å¢ ***ã€‘ å³æ™‚é›¨é‡è¨ˆæ™‚å™¨

                    // ã€*** æ–°å¢ ***ã€‘ å„²å­˜å‰ä¸€æ¬¡çš„10åˆ†é˜é›¨é‡
                    previousRain10Min: 0.0,

                    // è¨ˆæ™‚å™¨
                    countdown: 300,
                    dataInterval: null,
                    countdownInterval: null,
                    newCountdownValue: 300,
                    activeCountdownSetting: 300,

                    // è­¦ç¤ºç³»çµ±
                    isAudioEnabled: false,
                    alertMessage: null,
                    alertType: null, // 'forecast' æˆ– 'immediate'
                    rainLevelsText: ['ç„¡é›¨', 'å°é›¨', 'ä¸­é›¨', 'å¤§é›¨', 'æš´é›¨'],
                    speechVoices: [],
                    selectedVoice: null
                };
            },
            computed: {
                // é å ±å€’æ•¸
                countdownMinutes() {
                    return Math.floor(this.countdown / 60);
                },
                countdownSeconds() {
                    return (this.countdown % 60).toString().padStart(2, '0');
                },
                // ã€*** æ–°å¢ ***ã€‘ å³æ™‚é›¨é‡å€’æ•¸
                rainCountdownMinutes() {
                    return Math.floor(this.rainCountdown / 60);
                },
                rainCountdownSeconds() {
                    return (this.rainCountdown % 60).toString().padStart(2, '0');
                }
            },
            methods: {
                // --- ä¸»è¦è³‡æ–™ç²å– ---
                async fetchWeatherData() {
                    // ã€*** ä¿®æ”¹ ***ã€‘ åªé‡è¨­é å ±å€’æ•¸
                    this.countdown = this.activeCountdownSetting;

                    // ç¬¬ä¸€æ¬¡è¼‰å…¥æ™‚æ‰é¡¯ç¤ºå…¨å±€ loading
                    if (this.isLoading) {
                        try {
                            const response = await axios.get(this.forecastApiUrl);
                            if (response.data.success !== "true") {
                                throw new Error('å¤©æ°£é å ± API å›æ‡‰éŒ¯èª¤');
                            }
                            this.processData(response.data);
                            // è™•ç†å®Œè³‡æ–™å¾Œï¼Œæª¢æŸ¥æ˜¯å¦éœ€è¦ç™¼å‡ºè­¦ç¤º
                            this.checkRainAlert(this.locations);
                            // æˆ‘å€‘éœ€è¦ç­‰å¾…å…©æ¬¡ DOM æ›´æ–°
                            // ç¬¬ä¸€æ¬¡: v-if="!isLoading" ç”Ÿæ•ˆ
                            // ç¬¬äºŒæ¬¡: v-for="location in locations" ç”Ÿæ•ˆ
                            this.$nextTick(() => {
                                this.$nextTick(() => {
                                    this.renderAllCharts();
                                });
                            });
                        } catch (err) {
                            console.error("é å ± API è«‹æ±‚å¤±æ•—:", err);
                            this.error = "ç„¡æ³•å¾ä¸­å¤®æ°£è±¡ç½²ç²å–å¤©æ°£é å ±è³‡æ–™ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚";
                        } finally {
                            // åƒ…åœ¨ *ç¬¬ä¸€æ¬¡* è¼‰å…¥å®Œæˆå¾Œè¨­ç‚º false
                            this.isLoading = false;
                        }
                    } else {
                        // å¾ŒçºŒçš„èƒŒæ™¯æ›´æ–°
                        try {
                            const response = await axios.get(this.forecastApiUrl);
                            if (response.data.success !== "true") throw new Error('å¤©æ°£é å ± API å›æ‡‰éŒ¯èª¤');
                            this.processData(response.data);
                            this.checkRainAlert(this.locations);
                            this.$nextTick(() => this.renderAllCharts());
                        } catch (err) {
                            console.error("é å ± API èƒŒæ™¯æ›´æ–°å¤±æ•—:", err);
                        }
                    }
                },
                async fetchRainObservation() {
                    this.rainCountdown = 600;
                    try {
                        // ã€*** æ–°å¢ ***ã€‘ å„²å­˜å‰ä¸€æ¬¡çš„é›¨é‡å€¼
                        // æª¢æŸ¥ this.rainObservation æ˜¯å¦æœ‰ Past10Min å±¬æ€§
                        if (this.rainObservation && typeof this.rainObservation.Past10Min !== 'undefined') {
                            this.previousRain10Min = parseFloat(this.rainObservation.Past10Min);
                        }

                        const response = await axios.get(this.rainApiUrl);
                        if (response.data.success !== "true" || !response.data.records.Station[0]) {
                            throw new Error('å³æ™‚é›¨é‡ API å›æ‡‰éŒ¯èª¤');
                        }
                        const station = response.data.records.Station[0];
                        this.rainObservation = {
                            StationName: station.StationName,
                            ObsTime: station.ObsTime.DateTime,
                            Past10Min: station.RainfallElement.Past10Min.Precipitation,
                            Past1hr: station.RainfallElement.Past1hr.Precipitation,
                            Past24hr: station.RainfallElement.Past24hr.Precipitation,
                        };
                        this.checkImmediateRainAlert(this.rainObservation);
                    } catch (err) {
                        console.error("å³æ™‚é›¨é‡ API è«‹æ±‚å¤±æ•—:", err);
                    }
                },
                // --- è³‡æ–™è™•ç† ---
                processData(data) {
                    const currentTime = new Date();
                    const twentyFourHoursLater = new Date(currentTime.getTime() + 24 * 60 * 60 * 1000);
                    const rawLocations = data.records.Locations[0].Location;
                    this.locations = rawLocations.map(location => {
                        const tempElement = location.WeatherElement.find(el => el.ElementName === 'æº«åº¦').Time;
                        const apparentTempElement = location.WeatherElement.find(el => el.ElementName === 'é«”æ„Ÿæº«åº¦').Time;
                        const popElement = location.WeatherElement.find(el => el.ElementName === '3å°æ™‚é™é›¨æ©Ÿç‡').Time;
                        const weatherElement = location.WeatherElement.find(el => el.ElementName === 'å¤©æ°£ç¾è±¡').Time;
                        const allForecasts = popElement.map(popTime => {
                            const startTime = popTime.StartTime;
                            const startTimeObj = new Date(startTime);
                            const currentTemp = tempElement.find(t => new Date(t.DataTime).getTime() === startTimeObj.getTime());
                            const currentApparentTemp = apparentTempElement.find(t => new Date(t.DataTime).getTime() === startTimeObj.getTime());
                            const currentWx = weatherElement.find(wx => new Date(wx.StartTime).getTime() === startTimeObj.getTime());
                            const weatherCode = currentWx ? currentWx.ElementValue[0].WeatherCode : '0';
                            return {
                                startTime: startTime,
                                endTime: popTime.EndTime,
                                pop: popTime.ElementValue[0].ProbabilityOfPrecipitation,
                                temp: currentTemp ? currentTemp.ElementValue[0].Temperature : 'N/A',
                                apparentTemp: currentApparentTemp ? currentApparentTemp.ElementValue[0].ApparentTemperature : 'N/A',
                                weather: currentWx ? currentWx.ElementValue[0].Weather : 'N/A',
                                weatherCode: weatherCode,
                                rainLevel: this.getRainLevel(weatherCode)
                            };
                        });
                        // éæ¿¾å‡ºé–‹å§‹æ™‚é–“åœ¨ "ç¾åœ¨" åˆ° "24å°æ™‚å¾Œ" ä¹‹é–“çš„è³‡æ–™
                        const forecasts = allForecasts.filter(forecast => {
                            const forecastTime = new Date(forecast.startTime);
                            return forecastTime >= currentTime && forecastTime < twentyFourHoursLater;
                        });
                        return {name: location.LocationName, forecasts};
                    });
                },
                renderAllCharts() {
                    // --- åœ–è¡¨æ¸²æŸ“ ---
                    this.locations.forEach(location => {
                        this.renderWeatherChart(location);
                        this.renderRainChart(location);
                    });
                },
                renderWeatherChart(location) {
                    const canvasId = 'chart-' + location.name;
                    const ctx = document.getElementById(canvasId);
                    if (!ctx) return;
                    if (this.chartInstances[location.name]) this.chartInstances[location.name].destroy();
                    const forecasts = location.forecasts;
                    this.chartInstances[location.name] = new Chart(ctx.getContext('2d'), {
                        type: 'bar',
                        data: {
                            labels: forecasts.map(f => this.formatDate(f.startTime) + ' ' + this.formatTime(f.startTime)),
                            datasets: [
                                { type: 'line', label: 'æº«åº¦ (Â°C)', data: forecasts.map(f => f.temp), borderColor: 'rgba(255, 99, 132, 1)', yAxisID: 'y-temp', tension: 0.3 },
                                { type: 'line', label: 'é«”æ„Ÿæº«åº¦ (Â°C)', data: forecasts.map(f => f.apparentTemp), borderColor: 'rgba(255, 159, 64, 1)', yAxisID: 'y-temp', tension: 0.3, borderDash: [5, 5] },
                                { type: 'bar', label: 'é™é›¨æ©Ÿç‡ (%)', data: forecasts.map(f => f.pop), backgroundColor: 'rgba(54, 162, 235, 0.5)', yAxisID: 'y-pop' },
                            ]
                        },
                        options: {
                            responsive: true, maintainAspectRatio: false,
                            interaction: {mode: 'index', intersect: false},
                            scales: {
                                'y-temp': {type: 'linear', position: 'left', title: {display: true, text: 'æº«åº¦ (Â°C)'}},
                                'y-pop': {type: 'linear', position: 'right', min: 0, max: 100, title: {display: true, text: 'é™é›¨æ©Ÿç‡ (%)'}, grid: {drawOnChartArea: false}}
                            }
                        }
                    });
                },
                renderRainChart(location) {
                    const canvasId = 'rain-chart-' + location.name;
                    const ctx = document.getElementById(canvasId);
                    if (!ctx) return;
                    if (this.rainChartInstances[location.name]) this.rainChartInstances[location.name].destroy();
                    const rainForecasts = location.forecasts.slice(0, 8); // åªå–æœªä¾†24å°æ™‚ (8å€‹æ™‚æ®µ)
                    this.rainChartInstances[location.name] = new Chart(ctx.getContext('2d'), {
                        type: 'line',
                        data: {
                            labels: rainForecasts.map(f => this.formatDate(f.startTime) + ' ' + this.formatTime(f.startTime)),
                            datasets: [{
                                label: 'é™é›¨ç­‰ç´š',
                                data: rainForecasts.map(f => f.rainLevel),
                                borderColor: 'rgba(75, 192, 192, 1)',
                                backgroundColor: 'rgba(75, 192, 192, 0.2)',
                                stepped: true,
                                fill: true,
                            }]
                        },
                        options: {
                            responsive: true, maintainAspectRatio: false,
                            plugins: {legend: {display: false}},
                            scales: {
                                y: {
                                    min: 0,
                                    max: 4,
                                    ticks: {
                                        stepSize: 1,
                                        callback: (value, index, ticks) => this.rainLevelsText[value]
                                    }
                                }
                            }
                        }
                    });
                },
                getRainLevel(weatherCode) {
                    const code = parseInt(weatherCode);
                    if ([41].includes(code)) return 4;// æš´é›¨
                    if ([33, 34, 35, 36, 39, 42].includes(code)) return 3;// å¤§é›¨ (æœ‰å†°é›¹æˆ–æ™®éæ€§å¤§é›¨)
                    if ([13, 14, 15, 16, 17, 18, 21, 22].includes(code)) return 2;// ä¸­é›¨ (é›·é›¨æˆ–è¼ƒæŒçºŒçš„é›¨)
                    if ([8, 9, 10, 11, 12, 19, 20, 29, 30, 31, 32].includes(code)) return 1;// å°é›¨ (çŸ­æš«ã€é›¶æ˜Ÿçš„é›¨)
                    return 0;// ç„¡é›¨
                },
                // --- è¨ˆæ™‚å™¨èˆ‡è¨­å®š ---
                applyNewCountdown() {
                    this.error = null;
                    if (!this.newCountdownValue || this.newCountdownValue < 1) {
                        this.error = "è¼¸å…¥ç§’æ•¸ç„¡æ•ˆï¼Œå·²é‡è¨­ç‚ºé è¨­å€¼ 300 ç§’ã€‚";
                        this.activeCountdownSetting = 300;
                        this.newCountdownValue = 300;
                        this.fetchWeatherData();
                    } else {
                        this.activeCountdownSetting = this.newCountdownValue;
                    }
                    Tone.start();
                    this.countdown = this.activeCountdownSetting;
                    clearInterval(this.dataInterval);
                    this.dataInterval = setInterval(() => {
                        this.fetchWeatherData();
                    }, this.activeCountdownSetting * 1000);
                },
                startCountdownTicker() {
                    if (this.countdownInterval) clearInterval(this.countdownInterval);
                    this.countdownInterval = setInterval(() => {
                        if (this.countdown > 0) this.countdown--;
                    }, 1000);
                },
                // ã€*** æ–°å¢ ***ã€‘ å³æ™‚é›¨é‡å€’æ•¸
                startRainCountdownTicker() {
                    if (this.rainCountdownInterval) clearInterval(this.rainCountdownInterval);
                    this.rainCountdownInterval = setInterval(() => {
                        if (this.rainCountdown > 0) this.rainCountdown--;
                    }, 1000);
                },
                // --- è²éŸ³èˆ‡è­¦ç¤ºç³»çµ± ---
                async enableAudio() {
                    try {
                        await Tone.start();
                        this.isAudioEnabled = true;
                        this.playAlertSound();
                        console.log("éŸ³è¨Šå·²ç”±ä½¿ç”¨è€…å•Ÿç”¨ã€‚");
                        if (Tone.Transport.state !== "started") {
                            Tone.Transport.start();
                        }
                        this.loadSpeechVoices();
                    } catch (e) {
                        console.error("å•Ÿç”¨éŸ³è¨Šå¤±æ•—:", e);
                        this.error = "ç€è¦½å™¨é™åˆ¶ï¼Œç„¡æ³•å•Ÿç”¨éŸ³è¨Šã€‚";
                    }
                },
                loadSpeechVoices() {
                    window.speechSynthesis.onvoiceschanged = () => {
                        this.speechVoices = window.speechSynthesis.getVoices();
                        this.selectedVoice = this.speechVoices.find(v => v.name === 'Google ä¸­æ–‡ (è‡ºç£)')
                            || this.speechVoices.find(v => v.lang === 'zh-TW')
                            || this.speechVoices.find(v => v.lang.startsWith('zh'));
                        if (this.selectedVoice) console.log('å·²é¸ç”¨èªéŸ³:', this.selectedVoice.name);
                        else console.warn('æ‰¾ä¸åˆ°å¯ç”¨çš„ä¸­æ–‡èªéŸ³åŒ…ã€‚');
                    };
                    this.speechVoices = window.speechSynthesis.getVoices();
                    if (this.speechVoices.length > 0) window.speechSynthesis.onvoiceschanged();
                },
                playAlertSound() {
                    if (!this.isAudioEnabled) return;
                    try {
                        const synth = new Tone.Synth().toDestination();
                        const now = Tone.now();
                        const loop = new Tone.Loop(time => {
                            synth.triggerAttackRelease("C5", "16n", time);
                        }, "4n");
                        loop.start(now);
                        loop.stop(now + 5);
                        if (Tone.Transport.state !== "started") Tone.Transport.start();
                    } catch (e) {
                        console.error("æ’­æ”¾è²éŸ³å¤±æ•—:", e);
                    }
                },
                speakAlert(message) {
                    if (!this.isAudioEnabled || !this.selectedVoice) {
                        console.warn('èªéŸ³æœªå•Ÿç”¨æˆ–æ‰¾ä¸åˆ°èªéŸ³åŒ…ï¼Œç„¡æ³•æ’­æ”¾èªéŸ³ã€‚');
                        return;
                    }
                    try {
                        // æ¸…é™¤å¯èƒ½æ®˜ç•™çš„ä½‡åˆ—
                        window.speechSynthesis.cancel();
                        const utterance = new SpeechSynthesisUtterance(message);
                        utterance.voice = this.selectedVoice;
                        utterance.lang = this.selectedVoice.lang;
                        utterance.rate = 1.0;
                        window.speechSynthesis.speak(utterance);
                    } catch(e) { console.error("æ’­æ”¾èªéŸ³å¤±æ•—:", e); }
                },
                showRainAlert(message, type) {
                    this.alertMessage = message;
                    this.alertType = type;
                    setTimeout(() => {
                        if (this.alertMessage === message) {
                            this.alertMessage = null;
                            this.alertType = null;
                        }
                    }, 60000);
                },
                checkImmediateRainAlert(observation) {
                    if (!this.isAudioEnabled) return;
                    const rain10Min = parseFloat(observation.Past10Min);
                    const previousRain10Min = this.previousRain10Min; // å–å¾—å‰ä¸€æ¬¡çš„å€¼
                    const alertThreshold = 0.5;
                    const message = `å³æ™‚è­¦ç¤ºï¼šæ–°åº—è§€æ¸¬ç«™ 10 åˆ†é˜å…§é™é›¨é‡ç‚º ${rain10Min} æ¯«ç±³ï¼Œå·²é” ${alertThreshold} æ¯«ç±³è­¦ç¤ºæ¨™æº–ã€‚`;
                    // ã€*** ä¿®æ”¹ ***ã€‘ æª¢æŸ¥æ˜¯å¦ *è·¨è¶Š* é–€æª»ï¼šå‰ä¸€æ¬¡ < 0.5 ä¸” é€™ä¸€æ¬¡ >= 0.5
                    if (rain10Min >= alertThreshold && previousRain10Min < alertThreshold) {
                        // åªæœ‰ç•¶ *å‰›é–‹å§‹ä¸‹é›¨* ä¸” *ç›®å‰æ²’æœ‰* å³æ™‚è­¦ç¤ºæ™‚æ‰è§¸ç™¼ï¼Œ(this.alertType !== 'immediate' æ˜¯ç‚ºäº†é˜²æ­¢60ç§’å…§é‡è¤‡è§¸ç™¼)
                        if (this.alertType !== 'immediate') {
                            this.playAlertSound();
                            this.showRainAlert(message, 'immediate');
                            setTimeout(() => this.speakAlert(message), 5000);
                        }
                    } else if (rain10Min < alertThreshold) {
                        // å¦‚æœé›¨åœäº† (å°æ–¼ 0.5)ï¼Œä¸” *ç›®å‰æ˜¯* å³æ™‚è­¦ç¤ºï¼Œå‰‡è§£é™¤
                        if (this.alertType === 'immediate') {
                            this.alertMessage = null;
                            this.alertType = null;
                            window.speechSynthesis.cancel();
                        }
                    }
                    // å¦‚æœæ˜¯ (rain10Min >= 0.5 && previousRain10Min >= 0.5) (æŒçºŒä¸‹é›¨)
                    // å‰‡ä¸åšä»»ä½•äº‹ï¼Œè­¦ç¤ºè¨Šæ¯æœƒç…§å¸¸åœ¨ 60 ç§’å¾Œæ¶ˆå¤±ï¼Œä¸”ä¸æœƒå†æ¬¡è§¸ç™¼
                },
                checkRainAlert(locations) {
                    if (!this.isAudioEnabled || this.alertType === 'immediate') return;
                    let alertMessages = [];
                    const rainLevels = this.rainLevelsText;
                    for (const location of locations) {
                        if (!location.forecasts || location.forecasts.length < 2) continue;
                        const currentRainLevel = location.forecasts[0].rainLevel;
                        const nextRainLevel = location.forecasts[1].rainLevel;
                        const nextStartTime = this.formatTime(location.forecasts[1].startTime);
                        let alertReason = null;
                        if (currentRainLevel === 0 && nextRainLevel > 0) {
                            alertReason = `${location.name} é è¨ˆåœ¨ ${nextStartTime} å·¦å³å°‡å¾ ${rainLevels[currentRainLevel]} è½‰ç‚º ${rainLevels[nextRainLevel]}ã€‚`;
                        } else if (nextRainLevel > currentRainLevel && currentRainLevel > 0) {
                            alertReason = `${location.name} é è¨ˆåœ¨ ${nextStartTime} å·¦å³é›¨å‹¢å°‡å¾ ${rainLevels[currentRainLevel]} å¢å¼·ç‚º ${rainLevels[nextRainLevel]}ã€‚`;
                        }
                        if (alertReason) alertMessages.push(alertReason);
                    }
                    if (alertMessages.length > 0) {
                        const fullAlertMessage = "é å ±è­¦ç¤ºï¼š" + alertMessages.join(' ');
                        if (this.alertType !== 'forecast') {
                            this.playAlertSound();
                            this.showRainAlert(fullAlertMessage, 'forecast');
                            setTimeout(() => this.speakAlert(fullAlertMessage), 5000);
                        }
                    }
                },
                // --- æ ¼å¼åŒ–å·¥å…· ---
                formatTime(dateTimeStr) {
                    return new Date(dateTimeStr).toLocaleTimeString('zh-TW', { hour: '2-digit', minute: '2-digit', hour12: false });
                },
                formatDate(dateTimeStr) {
                    return new Date(dateTimeStr).toLocaleDateString('zh-TW', {month: '2-digit', day: '2-digit'});
                },
                formatFullDateTime(dateTimeStr) {
                    if (!dateTimeStr) return 'N/A';
                    return new Date(dateTimeStr).toLocaleString('zh-TW', {
                        year: 'numeric', month: '2-digit', day: '2-digit',
                        hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: false
                    });
                },
                getWeatherIconClass(code) {
                    const codeNum = parseInt(code);
                    if ([15, 16, 17, 18, 21, 22, 33, 34, 35, 36, 41].includes(codeNum)) return 'bi bi-cloud-lightning-rain-fill';
                    if ([8, 9, 10, 11, 12, 13, 14, 19, 20, 29, 30, 31, 32, 38, 39].includes(codeNum)) return 'bi bi-cloud-drizzle-fill';
                    if ([24, 25, 26, 27, 28].includes(codeNum)) return 'bi bi-cloud-fog2-fill';
                    if ([4, 5, 6, 7].includes(codeNum)) return 'bi bi-clouds-fill';
                    if (codeNum === 1) return 'bi bi-brightness-high-fill';
                    if ([2, 3].includes(codeNum)) return 'bi bi-cloud-sun-fill';
                    return 'bi bi-cloud-fill';
                }
            },
            mounted() {
                // 1. ç«‹å³ç²å–å¤©æ°£é å ±
                this.fetchWeatherData();
                // 2. ç«‹å³ç²å–å³æ™‚é›¨é‡
                this.fetchRainObservation();
                // 3. å•Ÿå‹•é å ±çš„å€’æ•¸è¨ˆæ™‚å™¨
                this.startCountdownTicker();
                // 4. ã€*** æ–°å¢ ***ã€‘ å•Ÿå‹•å³æ™‚é›¨é‡å€’æ•¸è¨ˆæ™‚å™¨
                this.startRainCountdownTicker();
                // 5. è¨­å®šé å ±çš„è‡ªå‹•æ›´æ–° (é è¨­ 300 ç§’)
                this.dataInterval = setInterval(() => {
                    this.fetchWeatherData();
                }, this.activeCountdownSetting * 1000);
                // 6. è¨­å®šå³æ™‚é›¨é‡çš„è‡ªå‹•æ›´æ–° (å›ºå®š 10 åˆ†é˜)
                this.rainInterval = setInterval(() => {
                    this.fetchRainObservation();
                }, 600000); // 10 åˆ†é˜
            },
            beforeUnmount() {
                for (const key in this.chartInstances) this.chartInstances[key].destroy();
                for (const key in this.rainChartInstances) this.rainChartInstances[key].destroy();
                clearInterval(this.dataInterval);
                clearInterval(this.countdownInterval);
                clearInterval(this.rainInterval);
                clearInterval(this.rainCountdownInterval); // ã€*** æ–°å¢ ***ã€‘ æ¸…é™¤é›¨é‡å€’æ•¸è¨ˆæ™‚å™¨
                window.speechSynthesis.cancel();
            }
        }).mount('#app');
    </script>

</body>

</html>

