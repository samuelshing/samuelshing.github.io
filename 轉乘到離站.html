<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>轉乘到離站</title>
    <!-- Bootstrap 4 -->
    <link href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet" />
    <!-- Vue 2 -->
    <script src="https://cdn.jsdelivr.net/npm/vue@2.6.14/dist/vue.js"></script>
    <style>
        body {
            background-color: #f0f2f5;
        }

        .card-direction {
            font-size: 1.2rem;
            font-weight: 500;
            color: #6c757d;
        }

        .destination-station {
            font-size: 2rem;
            font-weight: bold;
        }

        .arrival-time {
            font-size: 4rem;
            font-weight: bold;
            color: #dc3545;
        }

        .arrival-time-unit {
            font-size: 1.5rem;
            font-weight: 500;
            color: #dc3545;
            vertical-align: middle;
        }

        .arrival-status-arriving {
            color: #198754;
        }

        .update-time {
            color: #6c757d;
        }
    </style>
</head>

<body>
    <div id="app" class="container py-4">
        <header class="pb-3 mb-4 border-bottom">
            <h1 class="d-flex align-items-center text-dark text-decoration-none">
                <i class="bi bi-train-front me-3"></i>
                捷運即時到站資訊
            </h1>
        </header>

        <div v-if="isLoading" class="d-flex justify-content-center my-5">
            <div class="spinner-border" style="width: 3rem; height: 3rem;"><span
                    class="visually-hidden">Loading...</span></div>
        </div>
        <div v-if="error" class="alert alert-danger"><i class="bi bi-exclamation-triangle-fill me-2"></i> {{ error }}
        </div>

        <div v-if="!isLoading && !error">
            <section v-for="(system, systemKey) in metroData" :key="systemKey" class="mb-5">
                <h2 class="system-heading">{{ system.name }}</h2>
                <div class="row g-4">
                    <div v-for="station in system.stations" :key="station.StationID" class="col-md-6 col-lg-4">
                        <div class="card shadow-sm h-100">
                            <div class="card-header fw-bold d-flex justify-content-between align-items-center">
                                {{ station.StationName.Zh_tw }}
                                <i class="bi bi-geo-alt-fill card-header-icon"></i>
                            </div>
                            <div class="card-body d-flex flex-column justify-content-center text-center">
                                <div v-if="station.direction0 && station.direction0.length > 0" class="mb-3">
                                    <h6 class="direction-heading">往 {{ station.direction0[0].TripHeadSign }}</h6>
                                    <div class="my-2">
                                        <span class="arrival-time"
                                            :class="{ 'arrival-status-arriving': station.direction0[0].EstimateTime === 0 }">
                                            {{ formatEstimateTime(station.direction0[0].EstimateTime) }}
                                        </span>
                                        <span v-if="station.direction0[0].EstimateTime > 0" class="arrival-time-unit">
                                            分鐘
                                        </span>
                                    </div>
                                </div>
                                <hr v-if="station.direction0.length > 0 && station.direction1.length > 0">
                                <div v-if="station.direction1 && station.direction1.length > 0">
                                    <h6 class="direction-heading">往 {{ station.direction1[0].TripHeadSign }}</h6>
                                    <div class="my-2">
                                        <span class="arrival-time"
                                            :class="{ 'arrival-status-arriving': station.direction1[0].EstimateTime === 0 }">
                                            {{ formatEstimateTime(station.direction1[0].EstimateTime) }}
                                        </span>
                                        <span v-if="station.direction1[0].EstimateTime > 0" class="arrival-time-unit">
                                            分鐘
                                        </span>
                                    </div>
                                </div>

                                <div v-if="(!station.direction0 || station.direction0.length === 0) && (!station.direction1 || station.direction1.length === 0)"
                                    class="text-muted">
                                    目前無列車資訊
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </section>
        </div>

        <footer class="pt-3 mt-4 text-muted border-top">
            最後更新時間: {{ lastUpdateTime }}
        </footer>
    </div>

    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script>
        const { createApp, ref, onMounted } = Vue;

        createApp({
            setup() {
                // --- UNIFIED DATA STRUCTURE ---
                const metroData = ref({
                    TYMC: { name: '桃園機場捷運', stations: {} },
                    TRTC: { name: '台北捷運', stations: {} }
                });
                const isLoading = ref(true);
                const error = ref(null);
                const lastUpdateTime = ref('尚未更新');

                // --- TDX API Settings ---
                const accessToken = ref('eyJhbGciOiJSUzI1NiIsInR5cCIgOiAiSldUIiwia2lkIiA6ICJER2lKNFE5bFg4WldFajlNNEE2amFVNm9JOGJVQ3RYWGV6OFdZVzh3ZkhrIn0.eyJleHAiOjE3NjA3NzE4OTMsImlhdCI6MTc2MDY4NTQ5MywianRpIjoiYjIyZjcyYmItMGQ3OC00YzdiLTgzODgtYjVkNjY3OTFmNTcyIiwiaXNzIjoiaHR0cHM6Ly90ZHgudHJhbnNwb3J0ZGF0YS50dy9hdXRoL3JlYWxtcy9URFhDb25uZWN0Iiwic3ViIjoiOTk4ZTE3OWQtMDJiNi00NTkwLTkyYjAtMGNlNTBjYTY4ZWU0IiwidHlwIjoiQmVhcmVyIiwiYXpwIjoic2FtdWVsc2hpbmctYzg2N2Y3ZTktZGQ3Mi00NmE3IiwiYWNyIjoiMSIsInJlYWxtX2FjY2VzcyI6eyJyb2xlcyI6WyJzdGF0aXN0aWMiLCJwcmVtaXVtIiwicGFya2luZ0ZlZSIsIm1hYXMiLCJhZHZhbmNlZCIsImdlb2luZm8iLCJ2YWxpZGF0b3IiLCJ0b3VyaXNtIiwiaGlzdG9yaWNhbCIsImN3YSIsImJhc2ljIl19LCJzY29wZSI6InByb2ZpbGUgZW1haWwiLCJ1c2VyIjoiOTVmN2FmZjIifQ.nmPhzqIZzTbeQtrh-FHMeXyVDOD1sBS1fxFSdNQeqqs2UECUtFzfRuKU2lZjTOc7FoVqMVE4x3CP716-_WAKxwuvzEJexPHAwVsjEovJVfMovpY8IroLYFopQqfJOfnOgQCPvQ_EAnCa9t07s56RdjsEA5t1rdQ6DPyG5EUhJjmBTRKMhDzz-lmzOM0KRzhA5dfkasmVvZqP7g0z20P6iWA-o-mExE7zW0eE3VyctXy9wWKLRcrk47qx0jf36l2O12747NQau1lSB-cu0kjhvQrPxf7iTr8e1u7QR0xDGPk7akyDdEu1JMlogDZc8XUDXQ5Nmw_WRCsZtkcF1fiQug'); // *** Please replace with your actual Access Token ***
                const axiosInstance = axios.create({
                    headers: { 'Authorization': `Bearer ${accessToken.value}` }
                });

                // --- UNIFIED API URLS ---
                const API_URLS = {
                    TYMC: "https://tdx.transportdata.tw/api/basic/v2/Rail/Metro/LiveBoard/TYMC?$filter=StationID%20eq%20%27A3%27&$orderby=EstimateTime&$top=10&$format=JSON",
                    TRTC: "https://tdx.transportdata.tw/api/basic/v2/Rail/Metro/LiveBoard/TRTC?%24filter=StationID%20eq%20%27G04%27%20or%20StationID%20eq%20%27O02%27%20or%20StationID%20eq%20%27O17%27%20or%20StationID%20eq%20%27BL07%27%20or%20StationID%20eq%20%27BL08%27%20or%20StationID%20eq%20%27R27%27&%24orderby=EstimateTime&%24format=JSON"
                };
                const processMetroData = (apiData, systemKey) => {
                    const targetSystem = metroData.value[systemKey];
                    targetSystem.stations = {};
                    for (const train of apiData) {
                        if (!targetSystem.stations[train.StationID]) {
                            targetSystem.stations[train.StationID] = { StationID: train.StationID, StationName: train.StationName, direction0: [], direction1: [] };
                        }
                        let direction = (systemKey === 'TYMC') ? (train.DestinationStationID === 'A1' ? 0 : 1) : train.Direction;
                        if (direction === 0) {
                            targetSystem.stations[train.StationID].direction0.push(train);
                        } else if (direction === 1) {
                            targetSystem.stations[train.StationID].direction1.push(train);
                        }
                    }
                };
                const fetchData = async () => {
                    if (accessToken.value === 'YOUR_ACCESS_TOKEN') {
                        error.value = "請先在程式碼中填入您的 TDX API Access Token！";
                        isLoading.value = false; return;
                    }
                    isLoading.value = true; error.value = null;
                    try {
                        const [tymcRes, trtcRes] = await Promise.all([axiosInstance.get(API_URLS.TYMC), axiosInstance.get(API_URLS.TRTC)]);
                        processMetroData(tymcRes.data, 'TYMC');
                        processMetroData(trtcRes.data, 'TRTC');
                        lastUpdateTime.value = new Date().toLocaleTimeString();
                    } catch (e) {
                        console.error("資料抓取失敗:", e);
                        if (e.response) { error.value = `API 請求失敗: ${e.response.status} - ${e.response.data.message || '請檢查 Token 是否正確或過期。'}`; }
                        else { error.value = "無法載入列車資訊，請檢查您的網路連線。"; }
                    } finally {
                        isLoading.value = false;
                    }
                };
                const formatEstimateTime = (time) => (time === 0 ? '進站中' : time);
                onMounted(() => {
                    fetchData();
                    setInterval(fetchData, 30000);
                });
                return { metroData, isLoading, error, lastUpdateTime, formatEstimateTime };
            }
        }).mount('#app');
    </script>
</body>

</html>