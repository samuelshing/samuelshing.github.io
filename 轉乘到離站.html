<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>轉乘到離站</title>
    <!-- Bootstrap 4 -->
    <link href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet" />
    <!-- Vue 2 -->
    <script src="https://cdn.jsdelivr.net/npm/vue@2.6.14/dist/vue.js"></script>
    <style>
        body {
            background-color: #f0f2f5;
        }

        .card-direction {
            font-size: 1.2rem;
            font-weight: 500;
            color: #6c757d;
        }

        .destination-station {
            font-size: 2rem;
            font-weight: bold;
        }

        .arrival-time {
            font-size: 4rem;
            font-weight: bold;
            color: #dc3545;
        }

        .arrival-time-unit {
            font-size: 1.5rem;
            font-weight: 500;
            color: #dc3545;
            vertical-align: middle;
        }

        .arrival-status-arriving {
            color: #198754;
        }

        .update-time {
            color: #6c757d;
        }
    </style>
</head>

<body>
    <div id="app" class="container py-4">
        <header class="pb-3 mb-4 border-bottom">
            <h1 class="d-flex align-items-center text-dark text-decoration-none">
                <i class="bi bi-train-front me-3"></i>
                捷運即時到站資訊
            </h1>
        </header>

        <div v-if="isLoading" class="d-flex justify-content-center my-5">
            <div class="spinner-border" style="width: 3rem; height: 3rem;"><span
                    class="visually-hidden">Loading...</span></div>
        </div>
        <div v-if="error" class="alert alert-danger"><i class="bi bi-exclamation-triangle-fill me-2"></i> {{ error }}
        </div>

        <div v-if="!isLoading && !error">
            <section v-for="(system, systemKey) in metroData" :key="systemKey" class="mb-5">
                <h2 class="system-heading">{{ system.name }}</h2>
                <div class="row g-4">
                    <div v-for="station in system.stations" :key="station.StationID" class="col-md-6 col-lg-4">
                        <div class="card shadow-sm h-100">
                            <div class="card-header fw-bold d-flex justify-content-between align-items-center">
                                {{ station.StationName.Zh_tw }}
                                <i class="bi bi-geo-alt-fill card-header-icon"></i>
                            </div>
                            <div class="card-body">
                                <div v-if="station.direction0 && station.direction0.length > 0" class="mb-3">
                                    <h6 class="direction-heading">往 {{ station.direction0[0].TripHeadSign }}</h6>
                                    <ul class="list-group list-group-flush">
                                        <li v-for="(train, index) in station.direction0" :key="index"
                                            class="list-group-item d-flex justify-content-between align-items-center px-1">
                                            <span>第 {{ index + 1 }} 班</span>
                                            <span class="time-display" :class="{ arriving: train.EstimateTime === 0 }">
                                                {{ formatEstimateTime(train.EstimateTime) }}
                                                <span v-if="train.EstimateTime > 0" style="font-size: 0.8rem;">分</span>
                                            </span>
                                        </li>
                                    </ul>
                                </div>

                                <div v-if="station.direction1 && station.direction1.length > 0">
                                    <h6 class="direction-heading">往 {{ station.direction1[0].TripHeadSign }}</h6>
                                    <ul class="list-group list-group-flush">
                                        <li v-for="(train, index) in station.direction1" :key="index"
                                            class="list-group-item d-flex justify-content-between align-items-center px-1">
                                            <span>第 {{ index + 1 }} 班</span>
                                            <span class="time-display" :class="{ arriving: train.EstimateTime === 0 }">
                                                {{ formatEstimateTime(train.EstimateTime) }}
                                                <span v-if="train.EstimateTime > 0" style="font-size: 0.8rem;">分</span>
                                            </span>
                                        </li>
                                    </ul>
                                </div>

                                <div v-if="(!station.direction0 || station.direction0.length === 0) && (!station.direction1 || station.direction1.length === 0)"
                                    class="text-muted text-center pt-5">
                                    目前無列車資訊
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </section>
        </div>

        <footer class="pt-3 mt-4 text-muted border-top">
            最後更新時間: {{ lastUpdateTime }}
        </footer>
    </div>

    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script>
        const { createApp, ref, onMounted } = Vue;

        createApp({
            setup() {
                // --- UNIFIED DATA STRUCTURE ---
                const metroData = ref({
                    TYMC: { name: '桃園機場捷運', stations: {} },
                    TRTC: { name: '台北捷運', stations: {} }
                });
                const isLoading = ref(true);
                const error = ref(null);
                const lastUpdateTime = ref('尚未更新');

                // --- TDX API Settings ---
                const accessToken = ref('YOUR_ACCESS_TOKEN'); // *** Please replace with your actual Access Token ***
                const axiosInstance = axios.create({
                    // headers: { 'Authorization': `Bearer ${accessToken.value}` }
                });

                // --- UNIFIED API URLS ---
                const API_URLS = {
                    TYMC: "https://tdx.transportdata.tw/api/basic/v2/Rail/Metro/LiveBoard/TYMC?$filter=StationID%20eq%20%27A3%27&$orderby=EstimateTime&$top=10&$format=JSON",
                    TRTC: "https://tdx.transportdata.tw/api/basic/v2/Rail/Metro/LiveBoard/TRTC?%24filter=StationID%20eq%20%27G04%27%20or%20StationID%20eq%20%27O02%27%20or%20StationID%20eq%20%27O17%27%20or%20StationID%20eq%20%27BL07%27%20or%20StationID%20eq%20%27BL08%27%20or%20StationID%20eq%20%27R27%27&%24orderby=EstimateTime&%24format=JSON"
                };

                // --- REUSABLE DATA PROCESSING FUNCTION ---
                const processMetroData = (apiData, systemKey) => {
                    const targetSystem = metroData.value[systemKey];
                    targetSystem.stations = {}; // Clear previous data

                    for (const train of apiData) {
                        if (!targetSystem.stations[train.StationID]) {
                            targetSystem.stations[train.StationID] = {
                                StationID: train.StationID,
                                StationName: train.StationName,
                                direction0: [],
                                direction1: []
                            };
                        }

                        let direction;
                        // Custom logic for TYMC direction mapping
                        if (systemKey === 'TYMC') {
                            direction = (train.DestinationStationID === 'A1') ? 0 : 1; // 0 for Taipei, 1 for Airport/Huanbei
                        } else {
                            direction = train.Direction; // Standard logic for TRTC
                        }

                        if (direction === 0) {
                            targetSystem.stations[train.StationID].direction0.push(train);
                        } else if (direction === 1) {
                            targetSystem.stations[train.StationID].direction1.push(train);
                        }
                    }
                };

                const fetchData = async () => {
                    // if (accessToken.value === 'YOUR_ACCESS_TOKEN') {
                    //     error.value = "請先在程式碼中填入您的 TDX API Access Token！";
                    //     isLoading.value = false; return;
                    // }
                    isLoading.value = true;
                    error.value = null;

                    try {
                        const [tymcRes, trtcRes] = await Promise.all([
                            axiosInstance.get(API_URLS.TYMC),
                            axiosInstance.get(API_URLS.TRTC)
                        ]);

                        processMetroData(tymcRes.data, 'TYMC');
                        processMetroData(trtcRes.data, 'TRTC');

                        lastUpdateTime.value = new Date().toLocaleTimeString();
                    } catch (e) {
                        console.error("資料抓取失敗:", e);
                        if (e.response) { error.value = `API 請求失敗: ${e.response.status} - ${e.response.data.message || '請檢查 Token 是否正確或過期。'}`; }
                        else { error.value = "無法載入列車資訊，請檢查您的網路連線。"; }
                    } finally {
                        isLoading.value = false;
                    }
                };

                const formatEstimateTime = (time) => (time === 0 ? '進站中' : time);

                onMounted(() => {
                    fetchData();
                    setInterval(fetchData, 30000);
                });

                return { metroData, isLoading, error, lastUpdateTime, formatEstimateTime };
            }
        }).mount('#app');
    </script>
</body>

</html>