<!DOCTYPE html>
<html lang="zh-Hant">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å³æ™‚é›·é”å›æ³¢ç›£æ§</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">

    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.7.77/Tone.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/vue@3/dist/vue.global.prod.js"></script>

    <style>
        body {
            background-color: #f8f9fa;
        }

        #app {
            max-width: 900px;
            margin: auto;
            padding: 1rem;
        }

        /* å¡ç‰‡æ¨£å¼ */
        .radar-card {
            background-color: #ffffff;
            border: 1px solid #dee2e6;
            border-radius: 0.375rem;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            transition: all 0.3s ease;
        }

        .radar-card.alert-active {
            border-color: #dc3545;
            background-color: #fff5f5;
            animation: border-pulse 2s infinite;
        }

        /* èªªæ˜é¢æ¿æ¨£å¼ */
        .legend-color-box {
            width: 20px;
            height: 20px;
            display: inline-block;
            border-radius: 3px;
            vertical-align: middle;
            margin-right: 8px;
            border: 1px solid rgba(0, 0, 0, 0.1);
        }

        /* åœ–ç‰‡å®¹å™¨ */
        .radar-image-container {
            background-color: #212529;
            border-radius: 0.375rem;
            overflow: hidden;
            position: relative;
            min-height: 350px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .radar-image {
            width: 100%;
            height: auto;
            display: block;
            object-fit: contain;
        }

        @keyframes border-pulse {
            0% {
                box-shadow: 0 0 0 0px rgba(220, 53, 69, 0.4);
            }

            70% {
                box-shadow: 0 0 0 10px rgba(220, 53, 69, 0);
            }

            100% {
                box-shadow: 0 0 0 0px rgba(220, 53, 69, 0);
            }
        }

        /* å°è¦½é®ç½© */
        .tour-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background-color: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(3px);
            z-index: 9998;
        }

        .tour-tooltip {
            position: absolute;
            background-color: white;
            padding: 1.5rem;
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
            z-index: 10000;
            width: 320px;
            text-align: center;
        }
    </style>
</head>

<body>
    <div id="app">
        <div v-if="showOnboarding" class="tour-overlay" @click="closeTour"></div>
        <div v-if="showOnboarding" class="tour-tooltip" :style="tooltipStyle">
            <h5 class="mb-3">å•Ÿç”¨è²éŸ³è­¦ç¤º</h5>
            <p class="text-muted mb-3 small">ç€è¦½å™¨éœ€è¦è¨±å¯æ‰èƒ½æ’­æ”¾è­¦ç¤ºéŸ³ã€‚</p>
            <button class="btn btn-primary w-100" @click="enableAudio">
                <i class="bi bi-volume-up-fill me-1"></i> å•Ÿç”¨ä¸¦é–‹å§‹ç›£æ§
            </button>
        </div>

        <div class="app-content">
            <header class="text-center my-4">
                <h1 class="display-6 fw-bold">ğŸ“¡ é›·é”å›æ³¢ç›£æ§</h1>
                <p class="text-muted small">ï¼ˆæ–°åº—ã€ä¸­å’Œã€æ¿æ©‹å³æ™‚ dBZ æƒæ ï¼† æ¨¹æ—é›·é”åœ–ï¼‰</p>

                <div class="d-flex justify-content-center align-items-center gap-2 mb-3">
                    <button v-if="!isAudioEnabled" ref="enableAudioButtonRef" class="btn btn-info btn-sm text-white"
                        @click="enableAudio">
                        <i class="bi bi-bell-fill"></i> å•Ÿç”¨è²éŸ³
                    </button>
                    <span v-else
                        class="badge bg-success-subtle text-success border border-success px-3 py-2 rounded-pill">
                        <i class="bi bi-activity"></i> ç›£æ§ä¸­
                    </span>
                    <button class="btn btn-outline-secondary btn-sm" @click="fetchAllData" :disabled="isLoading">
                        <i class="bi bi-arrow-clockwise" :class="{'bi-spin': isLoading}"></i> {{ countdownSeconds }}s
                    </button>
                </div>
            </header>

            <div v-if="error" class="alert alert-danger shadow-sm py-2" role="alert">
                <i class="bi bi-exclamation-triangle-fill me-2"></i> {{ error }}
            </div>

            <main class="d-flex flex-column gap-4">
                <section>
                    <h4 class="text-center mb-3 h5 text-muted">æ¨¹æ—é›·é”ç«™å›æ³¢åœ–</h4>
                    <div class="radar-image-container shadow-sm">
                        <div v-if="isLoading && !radarImageUrl" class="text-light small">
                            <div class="spinner-border spinner-border-sm" role="status"></div> å½±åƒè¼‰å…¥ä¸­...
                        </div>
                        <img v-if="radarImageUrl" :src="radarImageUrl" alt="é›·é”å›æ³¢åœ–" class="radar-image"
                            @error="handleImageError">
                        <div v-if="radarImageTime"
                            class="position-absolute bottom-0 end-0 bg-dark text-white px-2 py-1 small opacity-75 rounded-top-start">
                            {{ formatFullDateTime(radarImageTime) }}
                        </div>
                    </div>
                </section>

                <section class="card shadow-sm border-0">
                    <div class="card-header bg-light fw-bold small text-muted">
                        <i class="bi bi-info-circle-fill me-1"></i> åˆ†ç´šå®šç¾©èˆ‡ç¤ºè­¦æ¢ä»¶
                    </div>
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table class="table table-sm table-bordered mb-0 text-center small align-middle">
                                <thead class="table-light">
                                    <tr>
                                        <th>é¡è‰²</th>
                                        <th>å¼·åº¦ (dBZ)</th>
                                        <th>é™é›¨ç­‰ç´š</th>
                                        <th>è²éŸ³ç¤ºè­¦</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td><span class="legend-color-box" style="background-color: #e9ecef;"></span>
                                        </td>
                                        <td>&lt; 15</td>
                                        <td class="text-muted">ç„¡å›æ³¢</td>
                                        <td class="text-muted">-</td>
                                    </tr>
                                    <tr>
                                        <td><span class="legend-color-box" style="background-color: #198754;"></span>
                                        </td>
                                        <td>15 ~ 30</td>
                                        <td class="text-success fw-bold">å°é›¨</td>
                                        <td>ç­‰ç´šæå‡æ™‚</td>
                                    </tr>
                                    <tr>
                                        <td><span class="legend-color-box" style="background-color: #fd7e14;"></span>
                                        </td>
                                        <td>30 ~ 45</td>
                                        <td class="text-warning fw-bold text-dark-emphasis">ä¸­é›¨</td>
                                        <td>ç­‰ç´šæå‡æ™‚</td>
                                    </tr>
                                    <tr>
                                        <td><span class="legend-color-box" style="background-color: #dc3545;"></span>
                                        </td>
                                        <td>45 ~ 55</td>
                                        <td class="text-danger fw-bold">å¤§é›¨</td>
                                        <td>ç­‰ç´šæå‡æ™‚</td>
                                    </tr>
                                    <tr>
                                        <td><span class="legend-color-box" style="background-color: #800080;"></span>
                                        </td>
                                        <td>&ge; 55</td>
                                        <td style="color: purple; font-weight: bold;">è±ªé›¨/é›·é›¨</td>
                                        <td>ç­‰ç´šæå‡æ™‚</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                        <div class="p-2 bg-light-subtle small text-muted border-top">
                            <strong><i class="bi bi-megaphone-fill"></i> è§¸ç™¼é‚è¼¯ï¼š</strong>
                            åƒ…ç•¶å›æ³¢å¼·åº¦ <strong>è·¨è¶Šé–€æª»å‘ä¸Šæå‡</strong> æ™‚ç™¼å‡ºè­¦ç¤º (å¦‚ï¼šç„¡â†’å°é›¨ï¼Œæˆ– å°é›¨â†’å¤§é›¨)ã€‚é›¨å‹¢æŒå¹³æˆ–æ¸›ç·©æ™‚ä¸æ‰“æ“¾ã€‚
                        </div>
                    </div>
                </section>

                <section>
                    <div v-if="isLoading && radarObservation.length === 0" class="text-center my-4 text-muted">
                        <div class="spinner-border spinner-border-sm text-secondary" role="status"></div>
                        <p class="mt-2 small">æ­£åœ¨æƒæé›·é”æ ¼é»...</p>
                    </div>

                    <div v-else class="row g-3">
                        <div v-for="loc in radarObservation" :key="loc.name" class="col-12 col-md-4">
                            <div class="p-3 radar-card h-100 d-flex flex-column justify-content-between"
                                :class="{'alert-active': loc.currentLevel >= 1}">
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <h5 class="mb-0 fw-bold">{{ loc.name }}</h5>
                                    <span class="badge rounded-pill"
                                        :style="{backgroundColor: getRadarColor(loc.dbz), color: loc.dbz >= 30 ? 'white' : 'white'}">
                                        {{ loc.status }}
                                    </span>
                                </div>

                                <div class="text-center my-3">
                                    <div class="display-6 fw-bold">{{ loc.dbz }}</div>
                                    <div class="text-muted small">dBZ</div>
                                </div>

                                <div class="progress" style="height: 8px;">
                                    <div class="progress-bar transition-all" role="progressbar"
                                        :style="{width: (Math.min(loc.dbz, 65) / 65 * 100) + '%', backgroundColor: getRadarColor(loc.dbz)}">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="text-center mt-3 text-muted small" v-if="dataTime">
                        è³‡æ–™æ™‚é–“ï¼š{{ formatFullDateTime(dataTime) }}
                    </div>
                </section>
            </main>

            <footer class="mt-5 text-center text-muted small pb-4">
                <p>è³‡æ–™ä¾†æºï¼šä¸­å¤®æ°£è±¡ç½² (Open Data)</p>
            </footer>
        </div>
    </div>

    <script>
        const { createApp } = Vue;

        createApp({
            data() {
                return {
                    // API è¨­å®š
                    // é›·é”åœ–ç‰‡ API (JSON å…§å« PNG ç¶²å€)
                    // radarPngUrl: 'https://opendata.cwa.gov.tw/fileapi/v1/opendataapi/O-A0084-001?Authorization=CWA-F36D4CE9-10F1-43BA-82E6-8E7DA63697F7&downloadType=WEB&format=JSON',
                    radarPngUrl: './get_radar_image.php',
                    // é›·é”æ•¸å€¼ API (JSON)
                    // radarApiUrl: 'https://opendata.cwa.gov.tw/fileapi/v1/opendataapi/O-A0059-001?Authorization=CWA-F36D4CE9-10F1-43BA-82E6-8E7DA63697F7&downloadType=WEB&format=JSON',
                    radarApiUrl: './get_radar.php',

                    // è³‡æ–™
                    radarObservation: [],
                    previousRadarDBZ: {}, // ç´€éŒ„ä¸Šä¸€æ¬¡çš„æ•¸å€¼
                    dataTime: null,
                    radarImageUrl: null,
                    radarImageTime: null,

                    // ç›£æ§åº§æ¨™
                    targetPoints: [
                        { name: "æ–°åº—", lat: 24.9828108, lng: 121.541716 },
                        { name: "ä¸­å’Œ", lat: 25.002385, lng: 121.496251 },
                        { name: "æ¿æ©‹", lat: 25.0153035, lng: 121.464625 }
                    ],

                    // ç‹€æ…‹
                    isLoading: true,
                    error: null,
                    showOnboarding: true,
                    isAudioEnabled: false,
                    tooltipStyle: { top: '50%', left: '50%', transform: 'translate(-50%, -50%)' },

                    // è¨ˆæ™‚å™¨
                    countdown: 300,
                    activeCountdownSetting: 300,
                    radarInterval: null,
                    countdownInterval: null,

                    // èªéŸ³
                    selectedVoice: null,
                };
            },
            computed: {
                countdownSeconds() { return this.countdown.toString().padStart(3, '0'); }
            },
            methods: {
                async fetchAllData() {
                    this.isLoading = true;
                    try {
                        await Promise.all([this.fetchRadarData(), this.fetchRadarImage()]);
                        this.error = null;
                        this.countdown = this.activeCountdownSetting;
                    } catch (e) { console.error(e); }
                    finally { this.isLoading = false; }
                },
                // --- æ ¸å¿ƒé‚è¼¯ï¼šç²å–é›·é”æ•¸å€¼èˆ‡åˆ¤æ–·è­¦ç¤º ---
                async fetchRadarData() {
                    try {
                        const response = await fetch(this.radarApiUrl, { cache: 'no-cache' });
                        if (!response.ok) throw new Error("API Error");
                        const data = await response.json();
                        if (data.error) throw new Error(data.error);

                        const dataset = data.cwaopendata.dataset;
                        const info = dataset.datasetInfo.parameterSet;
                        const content = dataset.contents.content;

                        this.dataTime = info.DateTime;
                        const startLng = parseFloat(info.StartPointLongitude);
                        const startLat = parseFloat(info.StartPointLatitude);
                        const res = parseFloat(info.GridResolution);
                        const dimX = parseInt(info.GridDimensionX);
                        const dbzValues = content.split(',').map(v => parseFloat(v));

                        const results = [];
                        let alertTriggered = false;
                        let alertText = "";

                        this.targetPoints.forEach(point => {
                            // è¨ˆç®—åº§æ¨™å°æ‡‰çš„é™£åˆ—ç´¢å¼•
                            const x_idx = Math.round((point.lng - startLng) / res);
                            const y_idx = Math.round((point.lat - startLat) / res);
                            const index = y_idx * dimX + x_idx;

                            let val = dbzValues[index] || 0;
                            if (val < 0) val = 0;

                            // 1. å–å¾—ä¸Šæ¬¡æ•¸å€¼èˆ‡ç­‰ç´š
                            const prevVal = this.previousRadarDBZ[point.name] || 0;
                            const prevLevel = this.getRadarLevel(prevVal);

                            // 2. å–å¾—æœ¬æ¬¡ç­‰ç´š
                            const currentLevel = this.getRadarLevel(val);
                            const statusText = this.getLevelText(currentLevel);

                            // 3. è­¦ç¤ºé‚è¼¯ï¼šç•¶ç­‰ç´šã€Œä¸Šå‡ã€ä¸”ç›®å‰æ˜¯æœ‰é›¨ç‹€æ…‹æ™‚
                            if (currentLevel > prevLevel && currentLevel > 0) {
                                alertTriggered = true;
                                if (prevLevel === 0) alertText += `${point.name}é–‹å§‹ä¸‹é›¨(${statusText})ï¼Œ`;
                                else alertText += `${point.name}é›¨å‹¢å¢å¼·ç‚º${statusText}ï¼Œ`;
                            }

                            results.push({
                                name: point.name,
                                dbz: val,
                                status: statusText,
                                currentLevel: currentLevel // ç”¨æ–¼ UI åˆ¤æ–·é¡è‰²
                            });

                            // æ›´æ–°æ­·å²
                            this.previousRadarDBZ[point.name] = val;
                        });

                        this.radarObservation = results;

                        if (alertTriggered && this.isAudioEnabled) {
                            this.playAlertSound();
                            setTimeout(() => this.speakAlert("æ°£è±¡è­¦ç¤ºï¼š" + alertText), 1000);
                        }

                    } catch (err) {
                        console.error("é›·é”æ•¸å€¼éŒ¯èª¤:", err);
                        this.error = "é›·é”æ•¸å€¼è®€å–å¤±æ•—";
                    }
                },
                // --- åœ–ç‰‡ ---
                async fetchRadarImage() {
                    try {
                        const res = await fetch(this.radarPngUrl);
                        const data = await res.json();
                        const r = data.cwaopendata.dataset.resource;
                        if (r && r.ProductURL) {
                            this.radarImageUrl = r.ProductURL + '?t=' + new Date().getTime();
                            this.radarImageTime = data.cwaopendata.dataset.DateTime;
                        }
                    } catch (e) { console.error("åœ–ç‰‡å¤±æ•—", e); }
                },
                // --- è¼”åŠ©å‡½å¼ï¼šåˆ†ç´šå®šç¾© ---
                getRadarLevel(dbz) {
                    if (dbz >= 55) return 4; // è±ªé›¨
                    if (dbz >= 45) return 3; // å¤§é›¨
                    if (dbz >= 30) return 2; // ä¸­é›¨
                    if (dbz >= 15) return 1; // å°é›¨
                    return 0;                // ç„¡é›¨
                },
                getLevelText(level) {
                    const texts = ["ç„¡å›æ³¢", "å°é›¨", "ä¸­é›¨", "å¤§é›¨", "è±ªé›¨"];
                    return texts[level] || "æœªçŸ¥";
                },
                getRadarColor(dbz) {
                    if (dbz >= 55) return '#800080'; // ç´«
                    if (dbz >= 45) return '#dc3545'; // ç´…
                    if (dbz >= 30) return '#fd7e14'; // æ©˜
                    if (dbz >= 15) return '#198754'; // ç¶ 
                    return '#adb5bd';                // ç°
                },
                handleImageError() {
                    this.radarImageUrl = null;
                    console.error("é›·é”åœ–ç‰‡è¼‰å…¥å¤±æ•—");
                },
                // --- è²éŸ³ç³»çµ± ---
                enableAudio() {
                    Tone.start().then(() => {
                        this.isAudioEnabled = true;
                        this.loadVoices();
                        this.playAlertSound();
                        this.closeTour();
                    });
                },
                loadVoices() {
                    const load = () => {
                        const v = speechSynthesis.getVoices();
                        this.selectedVoice = v.find(i => i.name === 'Google ä¸­æ–‡ (è‡ºç£)') || v.find(i => i.lang === 'zh-TW');
                    };
                    speechSynthesis.onvoiceschanged = load;
                    load();
                },
                playAlertSound() {
                    const synth = new Tone.Synth().toDestination();
                    const now = Tone.now();
                    synth.triggerAttackRelease("C5", "8n", now);
                    synth.triggerAttackRelease("E5", "8n", now + 0.1);
                    synth.triggerAttackRelease("G5", "8n", now + 0.2);
                },
                speakAlert(msg) {
                    if (!this.isAudioEnabled) return;
                    window.speechSynthesis.cancel();
                    const u = new SpeechSynthesisUtterance(msg);
                    if (this.selectedVoice) u.voice = this.selectedVoice;
                    window.speechSynthesis.speak(u);
                },
                // --- UI ---
                formatFullDateTime(s) {
                    return s ? new Date(s).toLocaleString('zh-TW', { month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit', hour12: false }) : '-';
                },
                startTour() {
                    this.$nextTick(() => {
                        if (window.innerWidth > 576) {
                            const rect = this.$refs.enableAudioButtonRef?.getBoundingClientRect();
                            if (rect) this.tooltipStyle = { top: (rect.bottom + 10) + 'px', left: (rect.left + rect.width / 2) + 'px', transform: 'translateX(-50%)' };
                        }
                    });
                },
                closeTour() { this.showOnboarding = false; }
            },
            mounted() {
                this.startTour();
                this.fetchAllData();
                this.countdownInterval = setInterval(() => { if (this.countdown > 0) this.countdown--; }, 1000);
                this.radarInterval = setInterval(() => this.fetchAllData(), 300000);
            },
            beforeUnmount() {
                clearInterval(this.radarInterval);
                clearInterval(this.countdownInterval);
                window.speechSynthesis.cancel();
            }
        }).mount('#app');
    </script>
</body>

</html>