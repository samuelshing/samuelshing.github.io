<!DOCTYPE html>
<html lang="zh-Hant">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å³æ™‚é›·é”å›æ³¢ç›£æ§</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">

    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.7.77/Tone.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/vue@3/dist/vue.global.prod.js"></script>

    <style>
        body {
            background-color: #f8f9fa;
        }

        #app {
            max-width: 800px;
            margin: auto;
            padding: 1rem;
        }

        .radar-card {
            background-color: #ffffff;
            border: 1px solid #dee2e6;
            border-radius: 0.375rem;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            transition: all 0.3s ease;
        }

        .radar-card.alert-active {
            border-color: #dc3545;
            background-color: #fff5f5;
            animation: border-pulse 2s infinite;
        }

        /* åœ–ç‰‡å¡ç‰‡æ¨£å¼ */
        .radar-image-container {
            /* background-color: #212529; */
            /* æ·±è‰²èƒŒæ™¯è¥¯æ‰˜é›·é”åœ– */
            border-radius: 0.375rem;
            overflow: hidden;
            position: relative;
            min-height: 350px;
            /* å›ºå®šæœ€å°é«˜åº¦é¿å…è·³å‹• */
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .radar-image {
            width: 80%;
            height: auto;
            display: block;
            object-fit: contain;
        }

        @keyframes border-pulse {
            0% {
                box-shadow: 0 0 0 0px rgba(220, 53, 69, 0.4);
            }

            70% {
                box-shadow: 0 0 0 10px rgba(220, 53, 69, 0);
            }

            100% {
                box-shadow: 0 0 0 0px rgba(220, 53, 69, 0);
            }
        }

        /* ç„¦é»å¼•å°æ¨£å¼ */
        .tour-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background-color: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(3px);
            z-index: 9998;
        }

        .tour-highlight-focus {
            position: relative;
            z-index: 9999;
            box-shadow: 0 0 0 10px rgba(255, 255, 255, 0.7);
            border-radius: 5px;
        }

        .tour-tooltip {
            position: absolute;
            background-color: white;
            padding: 1.5rem;
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
            z-index: 10000;
            max-width: 90%;
            width: 350px;
            text-align: center;
        }
    </style>
</head>

<body>
    <div id="app">
        <div v-if="showOnboarding" class="tour-overlay" @click="closeTour"></div>

        <div v-if="showOnboarding" class="tour-tooltip" :style="tooltipStyle">
            <h5 class="mb-3">å•Ÿç”¨è²éŸ³è­¦ç¤º</h5>
            <p class="text-muted mb-3">
                ç€è¦½å™¨éœ€è¦æ‚¨çš„è¨±å¯æ‰èƒ½åœ¨èƒŒæ™¯æ’­æ”¾è­¦ç¤ºéŸ³ã€‚<br>è«‹é»æ“Šä¸‹æ–¹æŒ‰éˆ•å•Ÿç”¨åŠŸèƒ½ã€‚
            </p>
            <button class="btn btn-primary w-100" @click="enableAudio">
                <i class="bi bi-volume-up-fill me-1"></i> å•Ÿç”¨ä¸¦é–‹å§‹ç›£æ§
            </button>
        </div>

        <div class="app-content">
            <header class="text-center my-4">
                <h1 class="display-5 fw-bold">ğŸ“¡ é›·é”å›æ³¢ç›£æ§</h1>
                <p class="text-muted">ï¼ˆæ–°åº—ã€ä¸­å’Œã€æ¿æ©‹å³æ™‚ dBZ æƒæ ï¼† æ¨¹æ—é›·é”åœ–ï¼‰</p>

                <div class="d-flex justify-content-center align-items-center gap-2 mb-3">
                    <button v-if="!isAudioEnabled" ref="enableAudioButtonRef" class="btn btn-info btn-sm"
                        :class="{ 'tour-highlight-focus': showOnboarding }" @click="enableAudio">
                        <i class="bi bi-bell-fill"></i> å•Ÿç”¨è²éŸ³è­¦ç¤º
                    </button>
                    <span v-if="isAudioEnabled"
                        class="text-success small fw-bold badge bg-success-subtle text-success border border-success px-3 py-2 rounded-pill">
                        <i class="bi bi-activity"></i> è²éŸ³ç›£æ§ä¸­
                    </span>
                </div>

                <div class="d-flex justify-content-center align-items-center gap-3 text-secondary small">
                    <span><i class="bi bi-clock-history"></i> è‡ªå‹•æ›´æ–°: {{ countdownSeconds }} ç§’</span>
                    <button class="btn btn-link btn-sm text-secondary p-0 text-decoration-none" @click="fetchAllData"
                        :disabled="isLoading">
                        <i class="bi bi-arrow-clockwise" :class="{'bi-spin': isLoading}"></i> ç«‹å³æ›´æ–°
                    </button>
                </div>
            </header>

            <div v-if="error" class="alert alert-danger mx-auto shadow-sm" role="alert">
                <i class="bi bi-exclamation-triangle-fill me-2"></i>
                <strong>é€£ç·šéŒ¯èª¤ï¼š</strong> {{ error }}
                <button class="btn btn-sm btn-outline-danger ms-3" @click="fetchAllData">é‡è©¦</button>
            </div>

            <main class="d-flex flex-column gap-4">
                <section>
                    <h4 class="text-center mb-3 h5 text-muted">æ¨¹æ—é›·é”ç«™å›æ³¢åœ–</h4>
                    <div class="radar-image-container shadow-sm">
                        <div v-if="isLoading && !radarImageUrl" class="text-light">
                            <div class="spinner-border spinner-border-sm" role="status"></div>
                            <span class="ms-2">å½±åƒè¼‰å…¥ä¸­...</span>
                        </div>

                        <img v-if="radarImageUrl" :src="radarImageUrl" alt="æ¨¹æ—é›·é”ç«™å›æ³¢åœ–" class="radar-image"
                            @error="handleImageError">

                        <div v-if="radarImageTime"
                            class="position-absolute bottom-0 end-0 bg-dark text-white px-3 py-1 small opacity-75 rounded-top-start">
                            {{ formatFullDateTime(radarImageTime) }}
                        </div>
                    </div>
                </section>

                <section>
                    <div class="alert alert-light border text-center text-secondary small mb-4">
                        <i class="bi bi-info-circle-fill me-1"></i>
                        dBZ å›æ³¢å€¼è¶Šé«˜ä»£è¡¨é™é›¨è¶ŠåŠ‡çƒˆã€‚<strong>>15 dBZ</strong> åˆ¤å®šç‚ºæœ‰é›¨ã€‚
                    </div>

                    <div v-if="isLoading && radarObservation.length === 0" class="text-center my-4 text-muted">
                        <div class="spinner-border text-secondary" role="status"></div>
                        <p class="mt-2 small">æ­£åœ¨æƒæé›·é”æ ¼é»...</p>
                    </div>

                    <div v-else class="row g-3">
                        <div v-for="loc in radarObservation" :key="loc.name" class="col-12">
                            <div class="p-3 radar-card d-flex align-items-center justify-content-between"
                                :class="{'alert-active': loc.dbz >= 15}">

                                <div class="d-flex align-items-center gap-3 flex-grow-1">
                                    <div class="text-center" style="min-width: 70px;">
                                        <h4 class="mb-0 fw-bold h5">{{ loc.name }}</h4>
                                    </div>
                                    <div style="min-width: 90px;">
                                        <div class="display-6 fw-bold mb-0 text-center fs-2">
                                            {{ loc.dbz }} <span class="fs-6 text-muted">dBZ</span>
                                        </div>
                                    </div>
                                </div>

                                <div class="flex-grow-1 mx-3 d-none d-md-block">
                                    <div class="progress" style="height: 10px;">
                                        <div class="progress-bar transition-all" role="progressbar"
                                            :style="{width: (Math.min(loc.dbz, 60) / 60 * 100) + '%', backgroundColor: getRadarColor(loc.dbz)}">
                                        </div>
                                    </div>
                                </div>

                                <div class="text-end" style="min-width: 80px;">
                                    <span class="badge rounded-pill"
                                        :class="loc.dbz >= 15 ? 'bg-danger' : 'bg-success'">
                                        {{ loc.status }}
                                    </span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="text-center mt-3 text-muted small" v-if="dataTime">
                        è³‡æ–™æ™‚é–“ï¼š{{ formatFullDateTime(dataTime) }}
                    </div>
                </section>
            </main>

            <footer class="mt-5 text-center text-muted small pb-4">
                <p>è³‡æ–™ä¾†æºï¼šä¸­å¤®æ°£è±¡ç½² (Open Data)</p>
            </footer>
        </div>
    </div>

    <script>
        const { createApp } = Vue;

        createApp({
            data() {
                return {
                    // API è¨­å®š
                    // é›·é”åœ–ç‰‡ API (JSON å…§å« PNG ç¶²å€)
                    // radarPngUrl: 'https://opendata.cwa.gov.tw/fileapi/v1/opendataapi/O-A0084-001?Authorization=CWA-F36D4CE9-10F1-43BA-82E6-8E7DA63697F7&downloadType=WEB&format=JSON',
                    radarPngUrl: './get_radar_image.php',
                    // é›·é”æ•¸å€¼ API (JSON)
                    // radarApiUrl: 'https://opendata.cwa.gov.tw/fileapi/v1/opendataapi/O-A0059-001?Authorization=CWA-F36D4CE9-10F1-43BA-82E6-8E7DA63697F7&downloadType=WEB&format=JSON',
                    radarApiUrl: './get_radar.php',

                    // è³‡æ–™ç‹€æ…‹
                    radarObservation: [],
                    previousRadarDBZ: {},
                    dataTime: null,

                    radarImageUrl: null,
                    radarImageTime: null,

                    // ç›£æ§åº§æ¨™
                    targetPoints: [
                        { name: "æ–°åº—", lat: 24.9828108, lng: 121.541716 },
                        { name: "ä¸­å’Œ", lat: 25.002385, lng: 121.496251 },
                        { name: "æ¿æ©‹", lat: 25.0153035, lng: 121.464625 }
                    ],

                    // ç³»çµ±ç‹€æ…‹
                    isLoading: true,
                    error: null,
                    showOnboarding: true,
                    isAudioEnabled: false,
                    tooltipStyle: { top: '50%', left: '50%', transform: 'translate(-50%, -50%)' }, // é è¨­ç½®ä¸­

                    // è¨ˆæ™‚å™¨
                    countdown: 300,
                    activeCountdownSetting: 300,
                    radarInterval: null,
                    countdownInterval: null, // æ–°å¢ï¼šå€’æ•¸è¨ˆæ™‚å™¨è®Šæ•¸

                    // èªéŸ³
                    selectedVoice: null,
                };
            },
            computed: {
                countdownSeconds() { return this.countdown.toString().padStart(3, '0'); }
            },
            methods: {
                async fetchAllData() {
                    this.isLoading = true;
                    // Error ä¸æ¸…ç©ºï¼Œä¿ç•™èˆŠçš„éŒ¯èª¤ç›´åˆ°æˆåŠŸï¼Œæˆ–åƒ…åœ¨éœ€è¦æ™‚æ¸…ç©º

                    try {
                        await Promise.all([
                            this.fetchRadarData(3, 0),
                            this.fetchRadarImage()
                        ]);
                        this.error = null; // æˆåŠŸå¾Œæ¸…ç©ºéŒ¯èª¤
                        this.countdown = this.activeCountdownSetting;
                    } catch (e) {
                        // é€™è£¡ catch å¯èƒ½æŠ“ä¸åˆ° Promise.all å…§éƒ¨çš„ errorï¼Œå› ç‚ºå…§éƒ¨æœ‰è‡ªå·±çš„ try-catch
                        // ä½†ä¿ç•™ä»¥é˜²è¬ä¸€
                    } finally {
                        this.isLoading = false;
                    }
                },
                async fetchRadarData(retries = 3, delay = 1000) {
                    try {
                        const response = await fetch(this.radarApiUrl, { method: 'GET', cache: 'no-cache' });
                        if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);

                        const data = await response.json();
                        if (data.error) throw new Error(data.error);

                        const dataset = data.cwaopendata.dataset;
                        const info = dataset.datasetInfo.parameterSet;
                        const content = dataset.contents.content;

                        if (!content) throw new Error("API è³‡æ–™ç•°å¸¸");

                        this.dataTime = info.DateTime;
                        const startLng = parseFloat(info.StartPointLongitude);
                        const startLat = parseFloat(info.StartPointLatitude);
                        const res = parseFloat(info.GridResolution);
                        const dimX = parseInt(info.GridDimensionX);
                        const dbzValues = content.split(',').map(v => parseFloat(v));

                        const results = [];
                        let alertTriggered = false;
                        let alertText = "";

                        this.targetPoints.forEach(point => {
                            const x_idx = Math.round((point.lng - startLng) / res);
                            const y_idx = Math.round((point.lat - startLat) / res);
                            const index = y_idx * dimX + x_idx;

                            let val = dbzValues[index] || 0;
                            if (val < 0) val = 0;

                            // 1. å–å¾—ä¸Šæ¬¡çš„æ•¸å€¼èˆ‡ç­‰ç´š
                            const prevVal = this.previousRadarDBZ[point.name] || 0;
                            const prevLevel = this.getRadarLevel(prevVal);

                            // 2. å–å¾—æœ¬æ¬¡çš„ç­‰ç´šèˆ‡ç‹€æ…‹æ–‡å­—
                            const currentLevel = this.getRadarLevel(val);
                            const statusText = this.getLevelText(currentLevel);

                            // 3. è­¦ç¤ºé‚è¼¯ï¼šç•¶ã€Œç­‰ç´šæå‡ã€æ™‚è§¸ç™¼ (ä¾‹å¦‚ï¼šç„¡é›¨->å°é›¨ï¼Œæˆ– å°é›¨->å¤§é›¨)
                            if (currentLevel > prevLevel && currentLevel > 0) {
                                alertTriggered = true;
                                // èªéŸ³å…§å®¹å„ªåŒ–ï¼šæ›´è‡ªç„¶çš„å£èª
                                if (prevLevel === 0) {
                                    alertText += `${point.name}é–‹å§‹ä¸‹é›¨(${statusText})ï¼Œ`;
                                } else {
                                    alertText += `${point.name}é›¨å‹¢å¢å¼·ç‚º${statusText}ï¼Œ`;
                                }
                            }

                            results.push({ name: point.name, dbz: val, status: statusText });

                            // æ›´æ–°æ­·å²ç´€éŒ„
                            this.previousRadarDBZ[point.name] = val;
                        });

                        this.radarObservation = results;

                        if (alertTriggered && this.isAudioEnabled) {
                            this.playAlertSound();
                            // èªéŸ³å»¶é²ä¸€é»é»ï¼Œè®“è­¦ç¤ºéŸ³å…ˆéŸ¿å®Œ
                            setTimeout(() => this.speakAlert("æ°£è±¡è­¦ç¤ºï¼š" + alertText + "è«‹ç•™æ„å®‰å…¨ã€‚"), 1000);
                        }

                    } catch (err) {
                        console.error(`é›·é”æ•¸å€¼ç²å–å¤±æ•—:`, err);
                        if (retries > 0) {
                            setTimeout(() => this.fetchRadarData(retries - 1, delay * 2), delay);
                        } else {
                            this.error = "ç„¡æ³•è®€å–é›·é”æ•¸å€¼";
                        }
                    }
                },
                async fetchRadarImage() {
                    try {
                        const response = await fetch(this.radarPngUrl, { method: 'GET', cache: 'no-cache' });
                        if (!response.ok) throw new Error(`Image API error`);

                        const data = await response.json();
                        if (data.error) throw new Error(data.error);

                        const resource = data.cwaopendata.dataset.resource;
                        const time = data.cwaopendata.dataset.DateTime; // ä¿®æ­£è·¯å¾‘

                        if (resource && resource.ProductURL) {
                            // åŠ å…¥æ™‚é–“æˆ³è¨˜é¿å…å¿«å–
                            this.radarImageUrl = resource.ProductURL + '?t=' + new Date().getTime();
                            this.radarImageTime = time;
                        }
                    } catch (err) {
                        console.error("é›·é”åœ–ç‰‡å¤±æ•—:", err);
                        // åœ–ç‰‡å¤±æ•—ä¸è¨­ç‚ºå…¨åŸŸéŒ¯èª¤ï¼Œåªåœ¨ console é¡¯ç¤º
                    }
                },
                // åˆ¤æ–· dBZ ç­‰ç´š (0~4)
                getRadarLevel(dbz) {
                    if (dbz >= 55) return 4; // è±ªé›¨/é›·é›¨ (ç´«è‰²)
                    if (dbz >= 45) return 3; // å¤§é›¨ (ç´…è‰²)
                    if (dbz >= 30) return 2; // ä¸­é›¨ (æ©˜è‰²)
                    if (dbz >= 15) return 1; // å°é›¨ (ç¶ è‰²)
                    return 0;                // ç„¡é›¨
                },
                // å–å¾—ç­‰ç´šå°æ‡‰æ–‡å­—
                getLevelText(level) {
                    switch (level) {
                        case 4: return "åŠ‡çƒˆé›·é›¨";
                        case 3: return "å¤§é›¨";
                        case 2: return "ä¸­é›¨";
                        case 1: return "å°é›¨";
                        default: return "ç„¡å›æ³¢";
                    }
                },
                // å–å¾—å°æ‡‰é¡è‰² (é…åˆæ–°çš„åˆ†ç´š)
                getRadarColor(dbz) {
                    if (dbz >= 55) return '#800080'; // ç´«è‰² (è±ªé›¨)
                    if (dbz >= 45) return '#dc3545'; // ç´…è‰² (å¤§é›¨)
                    if (dbz >= 30) return '#fd7e14'; // æ©˜è‰² (ä¸­é›¨)
                    if (dbz >= 15) return '#198754'; // ç¶ è‰² (å°é›¨)
                    return '#e9ecef';                // ç°è‰²
                },
                handleImageError() {
                    this.radarImageUrl = null;
                    console.error("é›·é”åœ–ç‰‡è¼‰å…¥å¤±æ•—");
                },
                // --- è²éŸ³ç³»çµ± ---
                enableAudio() {
                    Tone.start().then(() => {
                        this.isAudioEnabled = true;
                        this.loadSpeechVoices();
                        this.playAlertSound(); // æ’­æ”¾æ¸¬è©¦éŸ³æ•ˆ
                        this.closeTour();
                    }).catch(e => {
                        console.error('éŸ³è¨Šå•Ÿå‹•å¤±æ•—', e);
                        // å³ä½¿å¤±æ•—ä¹Ÿé—œé–‰å¼•å°ï¼Œé¿å…å¡ä½
                        this.closeTour();
                    });
                },
                loadSpeechVoices() {
                    const load = () => {
                        const v = speechSynthesis.getVoices();
                        this.selectedVoice = v.find(i => i.name === 'Google ä¸­æ–‡ (è‡ºç£)') || v.find(i => i.lang === 'zh-TW');
                    };
                    speechSynthesis.onvoiceschanged = load;
                    load(); // ç«‹å³å˜—è©¦ä¸€æ¬¡
                },
                playAlertSound() {
                    try {
                        const synth = new Tone.Synth().toDestination();
                        const now = Tone.now();
                        synth.triggerAttackRelease("C5", "8n", now);
                        synth.triggerAttackRelease("E5", "8n", now + 0.15);
                        synth.triggerAttackRelease("G5", "8n", now + 0.3);
                    } catch (e) { console.error("Tone.js Error:", e); }
                },
                speakAlert(msg) {
                    if (!this.isAudioEnabled) return;
                    window.speechSynthesis.cancel();
                    const u = new SpeechSynthesisUtterance(msg);
                    if (this.selectedVoice) u.voice = this.selectedVoice;
                    window.speechSynthesis.speak(u);
                },
                // --- UI ---
                formatFullDateTime(s) {
                    if (!s) return '-';
                    return new Date(s).toLocaleString('zh-TW', {
                        month: '2-digit', day: '2-digit',
                        hour: '2-digit', minute: '2-digit', hour12: false
                    });
                },
                startTour() {
                    this.$nextTick(() => {
                        // é è¨­å°‡æç¤ºæ¡†ç½®ä¸­é¡¯ç¤ºï¼Œä¸ä¾è³´æŒ‰éˆ•ä½ç½®ï¼Œé¿å…æ‰‹æ©Ÿæ¿è·‘ç‰ˆ
                        // å¦‚æœéœ€è¦ç²¾ç¢ºå®šä½åˆ°æŒ‰éˆ•ï¼Œå¯æ¢å¾©åŸæœ¬çš„ getBoundingClientRect é‚è¼¯
                        const rect = this.$refs.enableAudioButtonRef?.getBoundingClientRect();
                        if (rect && window.innerWidth > 576) {
                            // é›»è…¦ç‰ˆï¼šå®šä½åœ¨æŒ‰éˆ•ä¸‹æ–¹
                            this.tooltipStyle = { top: (rect.bottom + 15) + 'px', left: (rect.left + rect.width / 2) + 'px', transform: 'translateX(-50%)' };
                        } else {
                            // æ‰‹æ©Ÿç‰ˆï¼šç•«é¢æ­£ä¸­å¤®
                            this.tooltipStyle = { top: '50%', left: '50%', transform: 'translate(-50%, -50%)', width: '85%' };
                        }
                    });
                },
                closeTour() { this.showOnboarding = false; }
            },
            mounted() {
                this.startTour();
                this.fetchAllData();

                // ä¿®æ­£ï¼šè³¦å€¼çµ¦è®Šæ•¸ä»¥ä¾¿éŠ·æ¯€
                this.countdownInterval = setInterval(() => {
                    if (this.countdown > 0) this.countdown--;
                }, 1000);

                this.radarInterval = setInterval(() => this.fetchAllData(), 300000);
            },
            beforeUnmount() {
                clearInterval(this.radarInterval);
                clearInterval(this.countdownInterval); // ä¿®æ­£ï¼šæ¸…é™¤å€’æ•¸è¨ˆæ™‚å™¨
                window.speechSynthesis.cancel(); // é›¢é–‹æ™‚åœæ­¢èªªè©±
            }
        }).mount('#app');
    </script>
</body>

</html>