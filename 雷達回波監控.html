<!DOCTYPE html>
<html lang="zh-Hant">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å³æ™‚é›·é”å›æ³¢ç›£æ§</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">

    <!-- å¼•å…¥ Tone.js ç”¨æ–¼æ’­æ”¾éŸ³æ•ˆ -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.7.77/Tone.js"></script>
    <!-- å¼•å…¥ Vue 3 -->
    <script src="https://cdn.jsdelivr.net/npm/vue@3/dist/vue.global.prod.js"></script>

    <style>
        body {
            background-color: #f8f9fa;
        }

        #app {
            max-width: 800px; /* ä¸éœ€è¦å¤ªå¯¬ */
            margin: auto;
            padding: 1rem;
        }

        .radar-card {
            background-color: #ffffff;
            border: 1px solid #dee2e6;
            border-radius: 0.375rem;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            transition: all 0.3s ease;
        }

        .radar-card.alert-active {
            border-color: #dc3545;
            background-color: #fff5f5;
            animation: border-pulse 2s infinite;
        }

        @keyframes border-pulse {
            0% { box-shadow: 0 0 0 0px rgba(220, 53, 69, 0.4); }
            70% { box-shadow: 0 0 0 10px rgba(220, 53, 69, 0); }
            100% { box-shadow: 0 0 0 0px rgba(220, 53, 69, 0); }
        }

        /* ç„¦é»å¼•å°æ¨£å¼ */
        .tour-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background-color: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(3px);
            z-index: 9998;
        }

        .tour-highlight-focus {
            position: relative;
            z-index: 9999;
            box-shadow: 0 0 0 10px rgba(255, 255, 255, 0.7);
            border-radius: 5px;
        }

        .tour-tooltip {
            position: absolute;
            background-color: white;
            padding: 1.5rem;
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
            z-index: 10000;
            max-width: 350px;
            text-align: center;
        }
    </style>
</head>

<body>
    <div id="app">
        <!-- ç„¦é»å¼•å°é®ç½© -->
        <div v-if="showOnboarding" class="tour-overlay" @click="closeTour"></div>

        <!-- ç„¦é»å¼•å°æç¤ºæ¡† -->
        <div v-if="showOnboarding" class="tour-tooltip" :style="tooltipStyle">
            <h5 class="mb-3">å•Ÿç”¨è²éŸ³è­¦ç¤º</h5>
            <p class="text-muted mb-3">
                ç€è¦½å™¨éœ€è¦æ‚¨çš„è¨±å¯æ‰èƒ½åœ¨èƒŒæ™¯æ’­æ”¾è­¦ç¤ºéŸ³ã€‚è«‹é»æ“ŠæŒ‰éˆ•å•Ÿç”¨åŠŸèƒ½ã€‚
            </p>
            <button class="btn btn-primary btn-sm w-100" @click="triggerEnableAudio">æˆ‘çŸ¥é“äº†</button>
        </div>

        <div class="app-content">
            <header class="text-center my-4">
                <h1 class="display-5 fw-bold">ğŸ“¡ é›·é”å›æ³¢ç›£æ§</h1>
                <p class="text-muted">ï¼ˆæ–°åº—ã€ä¸­å’Œã€æ¿æ©‹å³æ™‚ dBZ æƒæï¼‰</p>
                
                <div class="d-flex justify-content-center align-items-center gap-2 mb-3">
                    <!-- å•Ÿç”¨éŸ³è¨ŠæŒ‰éˆ• -->
                    <button v-if="!isAudioEnabled" ref="enableAudioButtonRef" class="btn btn-info btn-sm"
                        :class="{ 'tour-highlight-focus': showOnboarding }" @click="enableAudio">
                        <i class="bi bi-bell-fill"></i> å•Ÿç”¨è²éŸ³è­¦ç¤º
                    </button>
                    <span v-if="isAudioEnabled" class="text-success small fw-bold">
                        <i class="bi bi-check-circle-fill"></i> è²éŸ³ç›£æ§ä¸­
                    </span>
                </div>
                
                <div class="d-flex justify-content-center align-items-center gap-3 text-secondary small">
                    <span><i class="bi bi-clock-history"></i> æ›´æ–°å€’æ•¸: {{ countdownSeconds }} ç§’</span>
                    <button class="btn btn-link btn-sm text-secondary p-0" @click="fetchRadarData(3, 0)" :disabled="isLoading">
                        <i class="bi bi-arrow-clockwise" :class="{'bi-spin': isLoading}"></i> ç«‹å³æ›´æ–°
                    </button>
                </div>
            </header>

            <!-- è¼‰å…¥ä¸­ç‹€æ…‹ -->
            <div v-if="isLoading" class="text-center my-5">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <p class="mt-2 text-muted">æ­£åœ¨åˆ†æé›·é”å›æ³¢æ•¸æ“š...</p>
            </div>

            <!-- éŒ¯èª¤è¨Šæ¯ -->
            <div v-if="error" class="alert alert-danger mx-auto" role="alert">
                <i class="bi bi-exclamation-triangle-fill"></i>
                <strong>éŒ¯èª¤ï¼š</strong> {{ error }}
                <button class="btn btn-sm btn-outline-danger ms-3" @click="fetchRadarData(3, 0)">é‡è©¦</button>
            </div>

            <main v-if="!isLoading" class="d-flex flex-column gap-4">
                
                <!-- é›·é”æƒæå€å¡Š -->
                <section>
                    <div class="alert alert-light border text-center text-secondary small mb-4">
                        <i class="bi bi-info-circle-fill me-1"></i> 
                        dBZ å›æ³¢å€¼è¶Šé«˜ä»£è¡¨é™é›¨è¶ŠåŠ‡çƒˆã€‚<strong>>15 dBZ</strong> åˆ¤å®šç‚ºæœ‰é›¨ä¸¦è§¸ç™¼è­¦ç¤ºã€‚
                    </div>
                    
                    <div class="row g-3">
                        <div v-for="loc in radarObservation" :key="loc.name" class="col-12">
                            <div class="p-3 radar-card d-flex align-items-center justify-content-between"
                                :class="{'alert-active': loc.dbz >= 15}">
                                
                                <div class="d-flex align-items-center gap-3">
                                    <div class="text-center" style="min-width: 80px;">
                                        <h4 class="mb-0 fw-bold">{{ loc.name }}</h4>
                                    </div>
                                    <div style="width: 120px;">
                                        <div class="display-6 fw-bold mb-0 text-center">
                                            {{ loc.dbz }} <span class="fs-6 text-muted">dBZ</span>
                                        </div>
                                    </div>
                                </div>

                                <div class="flex-grow-1 mx-3 d-none d-sm-block">
                                    <div class="progress" style="height: 12px;">
                                        <div class="progress-bar" role="progressbar"
                                            :style="{width: (Math.min(loc.dbz, 60) / 60 * 100) + '%', backgroundColor: getRadarColor(loc.dbz)}">
                                        </div>
                                    </div>
                                </div>

                                <div class="text-end" style="min-width: 100px;">
                                    <span :class="loc.dbz >= 15 ? 'text-danger fw-bold' : 'text-success'">
                                        {{ loc.status }}
                                    </span>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="text-center mt-3 text-muted small" v-if="dataTime">
                        è³‡æ–™æ™‚é–“ï¼š{{ formatFullDateTime(dataTime) }}
                    </div>
                </section>
            </main>
        </div>
    </div>

    <script>
        const { createApp } = Vue;

        createApp({
            data() {
                return {
                    radarPngUrl: 'https://opendata.cwa.gov.tw/fileapi/v1/opendataapi/O-A0084-001?Authorization=CWA-F36D4CE9-10F1-43BA-82E6-8E7DA63697F7&downloadType=WEB&format=JSON',
                    radarApiUrl: 'https://opendata.cwa.gov.tw/fileapi/v1/opendataapi/O-A0059-001?Authorization=CWA-F36D4CE9-10F1-43BA-82E6-8E7DA63697F7&format=JSON',
                    // radarApiUrl: './get_radar.php',

                    // è³‡æ–™
                    radarObservation: [],
                    previousRadarDBZ: {},
                    dataTime: null,
                    
                    // åº§æ¨™
                    targetPoints: [
                        { name: "æ–°åº—", lat: 24.9828108, lng: 121.541716 },
                        { name: "ä¸­å’Œ", lat: 25.002385, lng: 121.496251 },
                        { name: "æ¿æ©‹", lat: 25.0153035, lng: 121.464625 }
                    ],

                    // UI ç‹€æ…‹
                    isLoading: true,
                    error: null,
                    showOnboarding: true,
                    isAudioEnabled: false,
                    tooltipStyle: { top: '0px', left: '0px' },

                    // è¨ˆæ™‚å™¨
                    countdown: 300,
                    radarInterval: null,
                    activeCountdownSetting: 300,
                    
                    // èªéŸ³
                    selectedVoice: null,
                };
            },
            computed: {
                countdownSeconds() { return this.countdown.toString().padStart(3, '0'); }
            },
            methods: {
                async fetchRadarData(retries = 3, delay = 1000) {
                    this.isLoading = true;
                    this.error = null;

                    try {
                        const response = await fetch(this.radarApiUrl, {
                            method: 'GET',
                            mode: 'cors',
                            cache: 'no-cache'
                        });

                        if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                        
                        const data = await response.json();
                        const dataset = data.cwaopendata.dataset;
                        const info = dataset.datasetInfo.parameterSet;
                        const content = dataset.contents.content;

                        if (!content) throw new Error("API è³‡æ–™ç•°å¸¸");

                        // è¨˜éŒ„è³‡æ–™æ™‚é–“
                        this.dataTime = info.DateTime;

                        const startLng = parseFloat(info.StartPointLongitude);
                        const startLat = parseFloat(info.StartPointLatitude);
                        const res = parseFloat(info.GridResolution);
                        const dimX = parseInt(info.GridDimensionX);

                        const dbzValues = content.split(',').map(v => parseFloat(v));
                        const results = [];
                        let alertTriggered = false;
                        let alertText = "";

                        this.targetPoints.forEach(point => {
                            const x_idx = Math.round((point.lng - startLng) / res);
                            const y_idx = Math.round((point.lat - startLat) / res);
                            const index = y_idx * dimX + x_idx;

                            let val = dbzValues[index] || 0;
                            if (val < 0) val = 0;

                            const prevVal = this.previousRadarDBZ[point.name] || 0;
                            let status = "ç„¡å›æ³¢";
                            if (val >= 45) status = "åŠ‡çƒˆé›·é›¨";
                            else if (val >= 30) status = "æŒçºŒé™é›¨";
                            else if (val >= 15) status = "æœ‰é›¨";

                            if (val >= 15 && prevVal < 15) {
                                alertTriggered = true;
                                alertText += `${point.name} ${val}dBZï¼Œ`;
                            }

                            results.push({ name: point.name, dbz: val, status: status });
                            this.previousRadarDBZ[point.name] = val;
                        });

                        this.radarObservation = results;
                        this.countdown = this.activeCountdownSetting; // é‡ç½®å€’æ•¸

                        if (alertTriggered && this.isAudioEnabled) {
                            this.playAlertSound();
                            setTimeout(() => this.speakAlert("é›·é”è­¦ç¤ºï¼š" + alertText + "åµæ¸¬åˆ°é™é›¨å›æ³¢ã€‚"), 1500);
                        }
                        this.isLoading = false;

                    } catch (err) {
                        console.error(`ç²å–å¤±æ•— (å‰©é¤˜é‡è©¦: ${retries}):`, err);
                        if (retries > 0) {
                            setTimeout(() => this.fetchRadarData(retries - 1, delay * 2), delay);
                        } else {
                            this.error = "é›·é”è³‡æ–™ç²å–å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯ã€‚";
                            this.isLoading = false;
                        }
                    }
                },

                getRadarColor(dbz) {
                    if (dbz >= 50) return '#800080'; // ç´«è‰²
                    if (dbz >= 40) return '#ff0000'; // ç´…è‰²
                    if (dbz >= 30) return '#ffa500'; // æ©˜è‰²
                    if (dbz >= 15) return '#00ff00'; // ç¶ è‰²
                    return '#e9ecef'; // ç°è‰²
                },

                // --- è²éŸ³ç³»çµ± ---
                triggerEnableAudio() {
                    // æ¨¡æ“¬é»æ“Šä¸»è¦æŒ‰éˆ•
                    this.$refs.enableAudioButtonRef.click();
                },
                enableAudio() {
                    Tone.start().then(() => {
                        this.isAudioEnabled = true;
                        this.loadSpeechVoices();
                        this.playAlertSound();
                        this.closeTour();
                    }).catch(e => {
                        console.error('éŸ³è¨Šå•Ÿå‹•å¤±æ•—', e);
                        // å³ä½¿å¤±æ•—ä¹Ÿé—œé–‰å¼•å°ï¼Œé¿å…å¡ä½
                        this.closeTour();
                    });
                },
                loadSpeechVoices() {
                    speechSynthesis.onvoiceschanged = () => {
                        const v = speechSynthesis.getVoices();
                        this.selectedVoice = v.find(i => i.name === 'Google ä¸­æ–‡ (è‡ºç£)') || v.find(i => i.lang === 'zh-TW');
                    };
                    if (speechSynthesis.getVoices().length > 0) speechSynthesis.onvoiceschanged();
                },
                playAlertSound() {
                    const synth = new Tone.Synth().toDestination();
                    const now = Tone.now();
                    synth.triggerAttackRelease("C5", "16n", now);
                    synth.triggerAttackRelease("C5", "16n", now + 0.15);
                    synth.triggerAttackRelease("G5", "16n", now + 0.3);
                },
                speakAlert(msg) {
                    if (!this.isAudioEnabled || !this.selectedVoice) return;
                    window.speechSynthesis.cancel();
                    const u = new SpeechSynthesisUtterance(msg);
                    u.voice = this.selectedVoice;
                    window.speechSynthesis.speak(u);
                },

                // --- UI ---
                formatFullDateTime: s => new Date(s).toLocaleString('zh-TW', { hour12: false }),
                startTour() {
                    this.$nextTick(() => {
                        const rect = this.$refs.enableAudioButtonRef?.getBoundingClientRect();
                        if (rect) this.tooltipStyle = { top: (rect.bottom + 15) + 'px', left: '50%', transform: 'translateX(-50%)' };
                    });
                },
                closeTour() { this.showOnboarding = false; }
            },
            mounted() {
                this.startTour();
                this.fetchRadarData();

                // å€’æ•¸è¨ˆæ™‚
                setInterval(() => { if (this.countdown > 0) this.countdown--; }, 1000);
                
                // è‡ªå‹•æ›´æ–° (5åˆ†é˜)
                this.radarInterval = setInterval(() => this.fetchRadarData(), 300000);
            },
            beforeUnmount() {
                clearInterval(this.radarInterval);
            }
        }).mount('#app');
    </script>
</body>
</html>